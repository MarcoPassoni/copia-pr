/**
 * PENETRATION TEST RAPIDO - ICONIC Dashboard
 * Focus su vulnerabilit√† critiche per produzione
 */

const fs = require('fs');
const path = require('path');

console.log('üîç PENETRATION TEST RAPIDO - ICONIC');
console.log('===================================\n');

let criticalVulns = [];
let warnings = [];

// ========================================
// 1. SESSION SECURITY
// ========================================
console.log('1. üîê Test Session Security...');

const serverContent = fs.readFileSync('./server.js', 'utf8');

// Check session config
if (serverContent.includes('secure: false')) {
    criticalVulns.push('üî¥ CRITICO: Session cookies non sicuri (secure: false)');
}

if (serverContent.includes('iconic-secret-2024')) {
    criticalVulns.push('üî¥ CRITICO: Session secret hardcoded');
}

if (!serverContent.includes('httpOnly: true')) {
    criticalVulns.push('üî¥ CRITICO: Cookie accessibili via JavaScript');
}

// ========================================
// 2. AUTHENTICATION BYPASS
// ========================================
console.log('2. üö™ Test Authentication Bypass...');

const authContent = fs.readFileSync('./routes/auth.js', 'utf8');

// SQL injection in login
if (authContent.includes('getUserByNickname')) {
    const dbContent = fs.readFileSync('./models/db.js', 'utf8');
    if (!dbContent.includes('?') || !dbContent.includes('prepare')) {
        warnings.push('‚ö†Ô∏è  MEDIO: Possibili SQL injection in getUserByNickname');
    }
}

// Password policy
if (!authContent.includes('bcrypt')) {
    criticalVulns.push('üî¥ CRITICO: Password non hashate');
} else {
    console.log('   ‚úÖ Password hashate con bcrypt');
}

// ========================================
// 3. PRIVILEGE ESCALATION
// ========================================
console.log('3. üîù Test Privilege Escalation...');

const adminContent = fs.readFileSync('./routes/admin.js', 'utf8');

// Admin middleware check
if (!adminContent.includes("req.session.user.ruolo === 'admin'")) {
    criticalVulns.push('üî¥ CRITICO: Controllo ruolo admin mancante');
} else {
    console.log('   ‚úÖ Middleware admin presente');
}

// ========================================
// 4. DATA EXPOSURE
// ========================================
console.log('4. üìä Test Data Exposure...');

// Check for exposed sensitive data
const routes = ['./routes/admin.js', './routes/auth.js', './routes/pr.js'];
routes.forEach(route => {
    if (fs.existsSync(route)) {
        const content = fs.readFileSync(route, 'utf8');
        
        // Console.log with sensitive data
        if (content.includes('console.log') && content.includes('password')) {
            warnings.push(`‚ö†Ô∏è  MEDIO: Possibile log password in ${route}`);
        }
        
        // Unescaped user data
        if (content.includes('res.send(') && !content.includes('escape')) {
            warnings.push(`‚ö†Ô∏è  MEDIO: Output non sanitizzato in ${route}`);
        }
    }
});

// ========================================
// 5. ENCRYPTION SECURITY
// ========================================
console.log('5. üîí Test Encryption Security...');

if (fs.existsSync('./utils/crypto.js')) {
    const cryptoContent = fs.readFileSync('./utils/crypto.js', 'utf8');
    
    // Check for hardcoded keys
    if (cryptoContent.includes('createCipher') || cryptoContent.includes('Buffer.from(')) {
        warnings.push('‚ö†Ô∏è  MEDIO: Possibili chiavi crittografiche hardcoded');
    }
    
    // Check for weak crypto
    if (cryptoContent.includes('md5') || cryptoContent.includes('sha1')) {
        criticalVulns.push('üî¥ CRITICO: Algoritmi crittografici deboli');
    }
}

// ========================================
// 6. INPUT VALIDATION
// ========================================
console.log('6. ‚úÖ Test Input Validation...');

let hasValidation = false;
routes.forEach(route => {
    if (fs.existsSync(route)) {
        const content = fs.readFileSync(route, 'utf8');
        if (content.includes('validator') || content.includes('escape') || content.includes('sanitize')) {
            hasValidation = true;
        }
    }
});

if (!hasValidation) {
    criticalVulns.push('üî¥ CRITICO: Validazione input mancante');
}

// ========================================
// 7. ERROR HANDLING
// ========================================
console.log('7. ‚ö†Ô∏è  Test Error Handling...');

// Check for stack trace exposure
if (serverContent.includes('err.stack') || serverContent.includes('error.message')) {
    warnings.push('‚ö†Ô∏è  MEDIO: Possibile esposizione stack trace');
}

// ========================================
// 8. SECURITY HEADERS
// ========================================
console.log('8. üõ°Ô∏è  Test Security Headers...');

if (!serverContent.includes('helmet')) {
    criticalVulns.push('üî¥ CRITICO: Security headers mancanti (CSP, HSTS, etc.)');
} else {
    console.log('   ‚úÖ Helmet configurato');
}

// ========================================
// 9. DEPENDENCY SECURITY
// ========================================
console.log('9. üì¶ Test Dependencies...');

if (fs.existsSync('./package.json')) {
    const pkgContent = fs.readFileSync('./package.json', 'utf8');
    const pkg = JSON.parse(pkgContent);
    
    // Check for known vulnerable packages
    const vulnPackages = ['moment', 'request', 'lodash'];
    vulnPackages.forEach(vulnPkg => {
        if (pkg.dependencies && pkg.dependencies[vulnPkg]) {
            warnings.push(`‚ö†Ô∏è  MEDIO: Dipendenza potenzialmente vulnerabile: ${vulnPkg}`);
        }
    });
}

// ========================================
// 10. BUSINESS LOGIC
// ========================================
console.log('10. üè¢ Test Business Logic...');

// Check admin isolation
if (fs.existsSync('./utils/admin-data-filter.js')) {
    console.log('   ‚úÖ Sistema isolamento dati admin presente');
} else {
    warnings.push('‚ö†Ô∏è  MEDIO: Isolamento dati admin non implementato');
}

// ========================================
// REPORT FINALE
// ========================================
console.log('\n' + '='.repeat(50));
console.log('üö® PENETRATION TEST RESULTS');
console.log('='.repeat(50));

console.log(`\nüî¥ VULNERABILIT√Ä CRITICHE: ${criticalVulns.length}`);
criticalVulns.forEach(vuln => console.log(vuln));

console.log(`\n‚ö†Ô∏è  AVVISI: ${warnings.length}`);
warnings.forEach(warn => console.log(warn));

// Risk assessment
const riskLevel = criticalVulns.length > 3 ? 'üî¥ ALTO RISCHIO' : 
                 criticalVulns.length > 1 ? 'üü† MEDIO RISCHIO' : 
                 criticalVulns.length > 0 ? 'üü° BASSO RISCHIO' : 'üü¢ RISCHIO MINIMO';

console.log(`\nüéØ VALUTAZIONE RISCHIO: ${riskLevel}`);

// Immediate actions
if (criticalVulns.length > 0) {
    console.log('\nüö® AZIONI IMMEDIATE RICHIESTE:');
    if (criticalVulns.some(v => v.includes('Session cookies'))) {
        console.log('   1. Abilitare secure cookies per HTTPS');
    }
    if (criticalVulns.some(v => v.includes('secret hardcoded'))) {
        console.log('   2. Usare SESSION_SECRET da variabili ambiente');
    }
    if (criticalVulns.some(v => v.includes('Security headers'))) {
        console.log('   3. Configurare helmet per security headers');
    }
    if (criticalVulns.some(v => v.includes('Input validation'))) {
        console.log('   4. Implementare validazione input');
    }
} else {
    console.log('\n‚úÖ Nessuna vulnerabilit√† critica rilevata dal test automatico');
}

console.log('\nüìã RACCOMANDAZIONI PRODUZIONE:');
console.log('   ‚Ä¢ Abilitare HTTPS e secure cookies');
console.log('   ‚Ä¢ Implementare rate limiting');  
console.log('   ‚Ä¢ Monitorare log di sicurezza');
console.log('   ‚Ä¢ Audit dipendenze regolare');
console.log('   ‚Ä¢ Backup database crittografati');

console.log('\n‚ö†Ô∏è  NOTA: Test automatico limitato - audit manuale raccomandato');