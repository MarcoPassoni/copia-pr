<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sotto-Staff | <%= pr.nickname %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/img/favicon.ico">
</head>
<body>
  <%- include('sidebar') %>
  
  <div class="main-content">
    <!-- Header Dashboard -->
    <div class="page-header">
      <h1>üìä Dashboard Sotto-Staff</h1>
      <div class="manager-info">
        <span class="manager-badge">üéØ Manager: <%= pr.nickname %></span>
        <% if (pr.poteri == 1) { %>
          <span class="power-badge">‚ö° Con Poteri</span>
        <% } %>
      </div>
    </div>

    <!-- Statistiche Totali del Sotto-Staff -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-title">Membri Sotto-Staff</div>
          <div class="stat-number"><%= statisticheTotali.totaleSottoStaff %></div>
          <div class="stat-subtitle">PR attivi</div>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <div class="stat-title">Persone Portate</div>
          <div class="stat-number"><%= statisticheTotali.totalePersonePortate %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-icon">üçΩÔ∏è</div>
        <div class="stat-content">
          <div class="stat-title">Tavoli Approvati</div>
          <div class="stat-number"><%= statisticheTotali.totaleTavoli %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-title">Provvigioni Totali</div>
          <div class="stat-number">‚Ç¨<%= statisticheTotali.totaleProvvigioni.toFixed(2) %></div>
          <div class="stat-subtitle">Da pagare</div>
        </div>
      </div>
      
      <div class="stat-card secondary">
        <div class="stat-icon">üíé</div>
        <div class="stat-content">
          <div class="stat-title">Valore Storico</div>
          <div class="stat-number">‚Ç¨<%= statisticheTotali.totaleValoreStorico.toFixed(2) %></div>
          <div class="stat-subtitle">Totale da sempre</div>
        </div>
      </div>
    </div>

    <!-- Tabella Dettagliata del Sotto-Staff -->
    <% if (reportData && reportData.length > 0) { %>
    <div class="section">
      <h2>üìã Report Dettagliato del Sotto-Staff</h2>
      
      <div class="table-container">
        <table class="report-table">
          <thead>
            <tr>
              <th>üë§ Utente</th>
              <th>üè∑Ô∏è Ruolo</th>
              <th>üë§ Padre</th>
              <th>üíº % Prov.</th>
              <th>‚ö° Poteri</th>
              <th>üéØ Persone (Totali)</th>
              <th>üçΩÔ∏è Tavoli (Totali)</th>
              <th>üí∞ Provvigioni da Pagare</th>
              <th>üìä Totale Storico</th>
            </tr>
          </thead>
          <tbody>
            <% reportData.forEach(member => { %>
            <tr class="data-row level-<%= member.livello %>" data-member-id="<%= member.id %>" data-parent-id="<%= member.fk_padre || 'root' %>">
              <td class="user-cell">
                <div class="user-info" style="margin-left: <%= (member.livello - 1) * 20 %>px;">
                  <% if (member.has_children) { %>
                    <span class="expand-icon" onclick="toggleChildren('<%= member.id %>')" id="icon-<%= member.id %>">‚ñ∂</span>
                  <% } else { %>
                    <span class="no-children-icon">‚Ä¢</span>
                  <% } %>
                  <div class="user-details-inline">
                    <div class="user-nickname"><%= member.nickname %></div>
                    <div class="user-details"><%= member.nome %> <%= member.cognome %></div>
                  </div>
                </div>
              </td>
              <td>
                <span class="role-badge pr">PR</span>
                <% if (member.livello > 1) { %>
                  <div class="level-badge">Livello <%= member.livello %></div>
                <% } %>
              </td>
              <td>
                <span class="parent-info">üëÜ <%= member.padre_nickname %></span>
              </td>
              <td>
                <% if (member.percentuale_provvigione != null) { %>
                  <span class="percentage"><%= member.percentuale_provvigione %>%</span>
                <% } else { %>
                  <span class="no-data">-</span>
                <% } %>
              </td>
              <td>
                <span class="powers <%= member.poteri == 1 ? 'enabled' : 'disabled' %>">
                  <%= member.poteri == 1 ? '‚úÖ SI' : '‚ùå NO' %>
                </span>
              </td>
              <td class="stat-cell">
                <span class="main-stat"><%= member.totale_storico_persone %></span>
              </td>
              <td class="stat-cell">
                <span class="main-stat"><%= member.count_storico_tavoli %></span>
              </td>
              <td class="stat-cell">
                <span class="money">‚Ç¨<%= member.provvigioni_guadagnate.toFixed(2) %></span>
              </td>
              <td class="stat-cell">
                <div class="historic-stats">
                  <div>üë• <%= member.totale_storico_persone %> persone</div>
                  <div>üçΩÔ∏è <%= member.count_storico_tavoli %> tavoli</div>
                  <div class="money">üí∞ ‚Ç¨<%= member.totale_storico_valore.toFixed(2) %></div>
                </div>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } else { %>
    <!-- Messaggio quando non ci sono membri nel sotto-staff -->
    <div class="empty-state">
      <div class="empty-icon">üë•</div>
      <h3>Nessun membro nel sotto-staff</h3>
      <p>Non hai ancora collaboratori sotto di te. Quando avrai dei PR nel tuo team, i loro dati appariranno qui.</p>
    </div>
    <% } %>

    <!-- Sezione Organigramma Grafico -->
    <div class="section organigramma-section">
      <h2>üåê Organigramma del Sotto-Staff</h2>
      <p class="organigramma-subtitle">Visualizzazione interattiva della struttura gerarchica del tuo team</p>
      
      <!-- Controlli Organigramma -->
      <div class="organigramma-controls">
        <button class="control-btn active" id="viewHierarchy" data-mode="hierarchy">
          <i class="fas fa-sitemap"></i>
          <span>Vista Gerarchica</span>
        </button>
        <button class="control-btn" id="viewNetwork" data-mode="network">
          <i class="fas fa-project-diagram"></i>
          <span>Vista Rete</span>
        </button>
        <button class="control-btn" id="resetView">
          <i class="fas fa-refresh"></i>
          <span>Reset</span>
        </button>
      </div>
      
      <!-- Canvas Organigramma -->
      <div class="organigramma-container">
        <canvas id="organigramma-canvas"></canvas>
        
        <!-- Tooltip -->
        <div id="node-tooltip" class="node-tooltip">
          <div class="tooltip-header">
            <span class="tooltip-title"></span>
            <span class="tooltip-role"></span>
          </div>
          <div class="tooltip-content">
            <div class="tooltip-info"></div>
          </div>
        </div>
        
        <!-- Controlli zoom -->
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoom-in">
            <i class="fas fa-plus"></i>
          </button>
          <button class="zoom-btn" id="zoom-out">
            <i class="fas fa-minus"></i>
          </button>
          <button class="zoom-btn" id="zoom-fit">
            <i class="fas fa-expand-arrows-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Stili specifici per la dashboard sotto-staff */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }

    .manager-info {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .manager-badge {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .power-badge {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-card.primary { border-left-color: #007bff; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.info { border-left-color: #17a2b8; }
    .stat-card.secondary { border-left-color: #6c757d; }

    .stat-icon {
      font-size: 2rem;
      opacity: 0.8;
    }

    .stat-content {
      flex: 1;
    }

    .stat-title {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.25rem;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: #212529;
      margin-bottom: 0.25rem;
    }

    .stat-subtitle {
      font-size: 0.75rem;
      color: #6c757d;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 2rem 0;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      color: #6c757d;
      margin-bottom: 1rem;
    }

    .empty-state p {
      color: #868e96;
      max-width: 500px;
      margin: 0 auto 1rem;
    }

    /* Stili per la tabella report */
    .section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      margin-bottom: 1.5rem;
      color: #495057;
    }

    .table-container {
      overflow-x: auto;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .report-table th {
      background: #f8f9fa;
      padding: 1rem 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }

    .report-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-row:hover {
      background: #f8f9fa;
    }

    .user-cell {
      min-width: 150px;
    }

    .user-nickname {
      font-weight: 600;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .indent {
      color: #6c757d;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .level-indicator {
      color: #17a2b8;
      font-family: monospace;
      font-weight: bold;
    }

    .level-badge {
      font-size: 0.7rem;
      color: #6c757d;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 8px;
      margin-top: 0.25rem;
      display: inline-block;
    }

    /* Colorazione diversa per livelli diversi */
    .data-row[data-level="1"] {
      background: rgba(0, 123, 255, 0.02);
    }

    .data-row[data-level="2"] {
      background: rgba(40, 167, 69, 0.02);
    }

    .data-row[data-level="3"] {
      background: rgba(255, 193, 7, 0.02);
    }

    .data-row[data-level="4"] {
      background: rgba(220, 53, 69, 0.02);
    }

    .user-details {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .role-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-badge.pr {
      background: #e3f2fd;
      color: #1976d2;
    }

    .parent-info {
      color: #6c757d;
      font-size: 0.85rem;
    }

    .percentage {
      font-weight: 600;
      color: #17a2b8;
    }

    .powers.enabled {
      color: #28a745;
      font-weight: 600;
    }

    .powers.disabled {
      color: #dc3545;
      font-weight: 600;
    }

    .stat-cell {
      text-align: center;
    }

    .main-stat {
      font-weight: 700;
      font-size: 1.1rem;
      color: #495057;
    }

    .money {
      color: #28a745;
      font-weight: 700;
    }

    .historic-stats {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .historic-stats div {
      margin-bottom: 0.25rem;
    }

    .no-data {
      color: #6c757d;
      font-style: italic;
    }

    /* Stili per le frecce espandibili */
    .expand-icon {
      cursor: pointer;
      font-size: 1rem;
      margin-right: 8px;
      transition: transform 0.2s ease;
      color: #007bff;
      font-weight: bold;
      display: inline-block;
      width: 16px;
      text-align: center;
    }

    .expand-icon:hover {
      color: #0056b3;
      transform: scale(1.2);
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .no-children-icon {
      color: #6c757d;
      font-size: 0.8rem;
      margin-right: 8px;
      display: inline-block;
      width: 16px;
      text-align: center;
    }

    .user-details-inline {
      display: inline-block;
      vertical-align: middle;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    /* Nascondi inizialmente tutti i livelli > 1 */
    .data-row.level-2,
    .data-row.level-3,
    .data-row.level-4,
    .data-row.level-5 {
      display: none;
    }

    /* Mostra solo i livelli 1 inizialmente */
    .data-row.level-1 {
      display: table-row;
    }

    @media (max-width: 768px) {
      .stats-overview {
        grid-template-columns: 1fr;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .manager-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* CSS Organigramma */
    .organigramma-section {
      margin-top: 40px;
    }

    .organigramma-subtitle {
      color: #636e72;
      font-size: 1.1rem;
      margin-bottom: 25px;
    }

    .organigramma-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .control-btn:hover {
      border-color: #6c5ce7;
      color: #6c5ce7;
      transform: translateY(-2px);
    }

    .control-btn.active {
      background: #6c5ce7;
      color: white;
      border-color: #6c5ce7;
    }

    .organigramma-container {
      position: relative;
      width: 100%;
      height: 600px;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      background: #fafafa;
    }

    #organigramma-canvas {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #organigramma-canvas:active {
      cursor: grabbing;
    }

    .node-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .tooltip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
    }

    .tooltip-title {
      font-weight: bold;
      font-size: 1rem;
    }

    .tooltip-role {
      background: rgba(108, 92, 231, 0.8);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .tooltip-content {
      line-height: 1.4;
    }

    .zoom-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .zoom-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #636e72;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .zoom-btn:hover {
      background: white;
      color: #6c5ce7;
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .organigramma-controls {
        justify-content: center;
      }
      
      .control-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .organigramma-container {
        height: 400px;
      }
    }
  </style>

  <!-- Dati per l'organigramma -->
  <script>
    window.sottoStaffData = <%- JSON.stringify(sottoStaff) %>;
  </script>

  <script>
    function toggleChildren(parentId) {
      const icon = document.getElementById(`icon-${parentId}`);
      const rows = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      // Determina se espandere o contrarre
      const isExpanded = icon.classList.contains('expanded');
      
      if (isExpanded) {
        // Contrarre: nascondi tutti i figli e sottosottostanti
        collapseAllDescendants(parentId);
        icon.classList.remove('expanded');
        icon.textContent = '‚ñ∂';
      } else {
        // Espandere: mostra solo i figli diretti
        rows.forEach(row => {
          row.style.display = 'table-row';
        });
        icon.classList.add('expanded');
        icon.textContent = '‚ñº';
      }
    }

    function collapseAllDescendants(parentId) {
      const directChildren = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      directChildren.forEach(child => {
        child.style.display = 'none';
        
        // Chiudi anche le frecce dei figli
        const childId = child.getAttribute('data-member-id');
        const childIcon = document.getElementById(`icon-${childId}`);
        if (childIcon) {
          childIcon.classList.remove('expanded');
          childIcon.textContent = '‚ñ∂';
        }
        
        // Ricorsivamente chiudi tutti i discendenti
        collapseAllDescendants(childId);
      });
    }

    // Inizializzazione: mostra solo il primo livello
    document.addEventListener('DOMContentLoaded', function() {
      // Nascondi tutti i livelli superiori al primo
      const rows = document.querySelectorAll('.data-row');
      rows.forEach(row => {
        if (row.classList.contains('level-2') || 
            row.classList.contains('level-3') || 
            row.classList.contains('level-4') || 
            row.classList.contains('level-5')) {
          row.style.display = 'none';
        }
      });

      // Inizializza l'organigramma
      initOrganigramma();
    });

    // Sistema Organigramma
    let canvas, ctx, nodes = [], links = [], simulation;
    let transform = { x: 0, y: 0, scale: 1 };
    let isDragging = false, dragStart = { x: 0, y: 0 };
    let currentMode = 'hierarchy';
    let selectedNode = null;

    function initOrganigramma() {
      canvas = document.getElementById('organigramma-canvas');
      if (!canvas) return;
      
      ctx = canvas.getContext('2d');
      
      // Imposta dimensioni canvas
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Crea dati per l'organigramma
      createOrganigrammaData();
      
      // Eventi controlli
      setupControls();
      
      // Eventi canvas
      setupCanvasEvents();
      
      // Avvia animazione
      animate();
    }

    function resizeCanvas() {
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }

    function createOrganigrammaData() {
      nodes = [];
      links = [];
      
      // Usa i dati reali del sotto-staff
      const staffData = window.sottoStaffData || [];
      
      staffData.forEach(member => {
        nodes.push({
          id: member.id,
          name: member.nickname,
          role: 'PR',
          level: member.livello || 1,
          personePortate: member.personePortate || 0,
          tavoli: member.tavoli || 0,
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: 0,
          vy: 0,
          fx: null,
          fy: null,
          radius: Math.max(20, Math.min(40, 20 + (member.personePortate || 0) * 0.5))
        });
        
        // Crea link se ha un padre
        if (member.fk_padre) {
          links.push({
            source: member.fk_padre,
            target: member.id,
            strength: 0.8
          });
        }
      });
      
      // Se non ci sono dati, crea un nodo placeholder
      if (nodes.length === 0) {
        nodes.push({
          id: 'placeholder',
          name: 'Nessun sotto-staff',
          role: 'INFO',
          level: 1,
          personePortate: 0,
          tavoli: 0,
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: 0,
          vy: 0,
          fx: canvas.width / 2,
          fy: canvas.height / 2,
          radius: 30
        });
      }
      
      updateLayout();
    }

    function updateLayout() {
      if (currentMode === 'hierarchy') {
        layoutHierarchy();
      } else {
        layoutNetwork();
      }
    }

    function layoutHierarchy() {
      const levels = {};
      nodes.forEach(node => {
        if (!levels[node.level]) levels[node.level] = [];
        levels[node.level].push(node);
      });
      
      const levelHeight = canvas.height / (Object.keys(levels).length + 1);
      
      Object.keys(levels).forEach((level, levelIndex) => {
        const nodesInLevel = levels[level];
        const nodeWidth = canvas.width / (nodesInLevel.length + 1);
        
        nodesInLevel.forEach((node, nodeIndex) => {
          node.fx = nodeWidth * (nodeIndex + 1);
          node.fy = levelHeight * (levelIndex + 1);
          node.x = node.fx;
          node.y = node.fy;
        });
      });
    }

    function layoutNetwork() {
      nodes.forEach(node => {
        node.fx = null;
        node.fy = null;
      });
    }

    function setupControls() {
      document.getElementById('viewHierarchy')?.addEventListener('click', () => {
        setMode('hierarchy');
      });
      
      document.getElementById('viewNetwork')?.addEventListener('click', () => {
        setMode('network');
      });
      
      document.getElementById('resetView')?.addEventListener('click', () => {
        resetView();
      });
      
      document.getElementById('zoom-in')?.addEventListener('click', () => {
        zoom(1.2);
      });
      
      document.getElementById('zoom-out')?.addEventListener('click', () => {
        zoom(0.8);
      });
      
      document.getElementById('zoom-fit')?.addEventListener('click', () => {
        fitToScreen();
      });
    }

    function setMode(mode) {
      currentMode = mode;
      
      // Aggiorna bottoni
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`)?.classList.add('active');
      
      updateLayout();
    }

    function resetView() {
      transform = { x: 0, y: 0, scale: 1 };
    }

    function zoom(factor) {
      transform.scale *= factor;
      transform.scale = Math.max(0.1, Math.min(3, transform.scale));
    }

    function fitToScreen() {
      if (nodes.length === 0) return;
      
      let minX = Infinity, maxX = -Infinity;
      let minY = Infinity, maxY = -Infinity;
      
      nodes.forEach(node => {
        minX = Math.min(minX, node.x - node.radius);
        maxX = Math.max(maxX, node.x + node.radius);
        minY = Math.min(minY, node.y - node.radius);
        maxY = Math.max(maxY, node.y + node.radius);
      });
      
      const width = maxX - minX;
      const height = maxY - minY;
      const scale = Math.min(canvas.width / width, canvas.height / height) * 0.8;
      
      transform.scale = scale;
      transform.x = (canvas.width - (minX + maxX) * scale) / 2;
      transform.y = (canvas.height - (minY + maxY) * scale) / 2;
    }

    function setupCanvasEvents() {
      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      canvas.addEventListener('wheel', onWheel);
      canvas.addEventListener('mouseleave', hideTooltip);
    }

    function onMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const node = getNodeAt(x, y);
      if (node) {
        selectedNode = node;
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      } else {
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      }
    }

    function onMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      if (isDragging) {
        if (selectedNode) {
          const worldX = (x - transform.x) / transform.scale;
          const worldY = (y - transform.y) / transform.scale;
          selectedNode.fx = worldX;
          selectedNode.fy = worldY;
          selectedNode.x = worldX;
          selectedNode.y = worldY;
        } else {
          transform.x = x - dragStart.x;
          transform.y = y - dragStart.y;
        }
      } else {
        const node = getNodeAt(x, y);
        if (node) {
          showTooltip(node, x, y);
          canvas.style.cursor = 'pointer';
        } else {
          hideTooltip();
          canvas.style.cursor = 'grab';
        }
      }
    }

    function onMouseUp() {
      isDragging = false;
      selectedNode = null;
    }

    function onWheel(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = transform.scale * factor;
      
      if (newScale >= 0.1 && newScale <= 3) {
        transform.x = x - (x - transform.x) * factor;
        transform.y = y - (y - transform.y) * factor;
        transform.scale = newScale;
      }
    }

    function getNodeAt(x, y) {
      const worldX = (x - transform.x) / transform.scale;
      const worldY = (y - transform.y) / transform.scale;
      
      return nodes.find(node => {
        const dx = worldX - node.x;
        const dy = worldY - node.y;
        return Math.sqrt(dx * dx + dy * dy) <= node.radius;
      });
    }

    function showTooltip(node, x, y) {
      const tooltip = document.getElementById('node-tooltip');
      if (!tooltip) return;
      
      tooltip.querySelector('.tooltip-title').textContent = node.name;
      tooltip.querySelector('.tooltip-role').textContent = node.role;
      tooltip.querySelector('.tooltip-info').innerHTML = `
        <div>üë• Persone portate: ${node.personePortate}</div>
        <div>üçΩÔ∏è Tavoli: ${node.tavoli}</div>
        <div>üìä Livello: ${node.level}</div>
      `;
      
      tooltip.style.left = x + 10 + 'px';
      tooltip.style.top = y - 10 + 'px';
      tooltip.style.opacity = '1';
    }

    function hideTooltip() {
      const tooltip = document.getElementById('node-tooltip');
      if (tooltip) {
        tooltip.style.opacity = '0';
      }
    }

    function animate() {
      draw();
      requestAnimationFrame(animate);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.save();
      ctx.translate(transform.x, transform.y);
      ctx.scale(transform.scale, transform.scale);
      
      // Disegna link
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 2;
      links.forEach(link => {
        const source = nodes.find(n => n.id === link.source);
        const target = nodes.find(n => n.id === link.target);
        if (source && target) {
          ctx.beginPath();
          ctx.moveTo(source.x, source.y);
          ctx.lineTo(target.x, target.y);
          ctx.stroke();
        }
      });
      
      // Disegna nodi
      nodes.forEach(node => {
        // Cerchio esterno
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.radius, 0, 2 * Math.PI);
        ctx.fillStyle = node.id === 'placeholder' ? '#bbb' : '#6c5ce7';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Testo
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${Math.max(10, node.radius * 0.3)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(node.name.substring(0, 8), node.x, node.y);
      });
      
      ctx.restore();
    }
  </script>

</body>
</html>
