<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PR - Aura</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" sizes="32x32" href="/img/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .stat-card.personal {
            border-left: 4px solid #2196F3;
        }
        
        .stat-card.team {
            border-left: 4px solid #4CAF50;
        }
        
        .stat-card.comparison {
            border-left: 4px solid #FF9800;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-sublabel {
            color: #999;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .team-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .team-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .team-member:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: bold;
            color: #333;
        }
        
        .member-role {
            color: #666;
            font-size: 0.9em;
        }
        
        .member-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }
        
        .member-stat {
            text-align: center;
        }
        
        .member-stat-value {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .member-stat-label {
            color: #666;
            font-size: 0.8em;
        }
        
        .no-team {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .welcome-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 10px;
        }
        
        .welcome-header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        .welcome-header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px 10px 3rem 10px; /* Aggiungi padding-bottom */
                margin-bottom: 2rem; /* Spazio extra in fondo */
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.8em;
            }
            
            .member-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .team-member {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.3em;
            }
            
            .welcome-header h1 {
                font-size: 1.8em;
            }
            
            /* Assicura spazio per il contenuto */
            body {
                padding-bottom: 3rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 5px 5px 4rem 5px; /* Ancora pi√π padding-bottom */
                margin-bottom: 3rem;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .stat-label {
                font-size: 0.9em;
            }
            
            .section-title {
                font-size: 1.2em;
            }
            
            .welcome-header h1 {
                font-size: 1.5em;
            }
            
            .welcome-header p {
                font-size: 0.9em;
            }
            
            /* Ancora pi√π spazio per mobile piccoli */
            body {
                padding-bottom: 4rem !important;
            }
        }
    </style>
</head>
<body>
    <%- include('sidebar') %>
    
    <div class="main-content">
        <div class="dashboard-container">
            <!-- Header di benvenuto -->
            <div class="welcome-header">
                <h1>Dashboard di <%= user.nickname %></h1>
                <p>Panoramica completa delle tue performance e del tuo team</p>
            </div>

            <!-- Statistiche Personali -->
            <div class="stats-section">
                <h2 class="section-title">üìä Le Tue Statistiche Personali</h2>
                <div class="stats-grid">
                    <div class="stat-card personal">
                        <div class="stat-label">Prenotazioni Personali</div>
                        <div class="stat-value"><%= stats.prenotazioni_personali %></div>
                        <div class="stat-sublabel">Tavoli che hai portato</div>
                    </div>
                    <div class="stat-card personal">
                        <div class="stat-label">Fatturato Personale</div>
                        <div class="stat-value">‚Ç¨<%= (stats.fatturato_personale || 0).toLocaleString() %></div>
                        <div class="stat-sublabel">Ricavi dai tuoi tavoli</div>
                    </div>
                    <div class="stat-card personal">
                        <div class="stat-label">Provvigioni Personali</div>
                        <div class="stat-value">‚Ç¨<%= (stats.provvigioni_personali || 0).toLocaleString() %></div>
                        <div class="stat-sublabel">Da ricevere</div>
                    </div>
                </div>
            </div>

            <% if (stats.has_team) { %>
            <!-- Statistiche Totali (Tu + Team) -->
            <div class="stats-section">
                <h2 class="section-title">üèÜ Statistiche Totali (Tu + Team)</h2>
                <div class="stats-grid">
                    <div class="stat-card team">
                        <div class="stat-label">Prenotazioni Totali</div>
                        <div class="stat-value"><%= stats.prenotazioni_totali %></div>
                        <div class="stat-sublabel">Tu + <%= stats.numero_figli %> membri del team</div>
                    </div>
                    <div class="stat-card team">
                        <div class="stat-label">Fatturato Totale</div>
                        <div class="stat-value">‚Ç¨<%= (stats.fatturato_totale || 0).toLocaleString() %></div>
                        <div class="stat-sublabel">Ricavi complessivi del team</div>
                    </div>
                    <div class="stat-card team">
                        <div class="stat-label">Provvigioni Totali</div>
                        <div class="stat-value">‚Ç¨<%= (stats.provvigioni_totali || 0).toLocaleString() %></div>
                        <div class="stat-sublabel">Team completo</div>
                    </div>
                </div>
            </div>

            <!-- Confronto Performance -->
            <div class="stats-section">
                <h2 class="section-title">‚ö° Performance Comparison</h2>
                <div class="stats-grid">
                    <div class="stat-card comparison">
                        <div class="stat-label">Il Tuo Contributo</div>
                        <div class="stat-value"><%= stats.prenotazioni_totali > 0 ? Math.round((stats.prenotazioni_personali / stats.prenotazioni_totali) * 100) : 0 %>%</div>
                        <div class="stat-sublabel">Delle prenotazioni totali</div>
                    </div>
                    <div class="stat-card comparison">
                        <div class="stat-label">Team Performance</div>
                        <div class="stat-value"><%= stats.prenotazioni_totali - stats.prenotazioni_personali %></div>
                        <div class="stat-sublabel">Prenotazioni del team</div>
                    </div>
                    <div class="stat-card comparison">
                        <div class="stat-label">Moltiplicatore Team</div>
                        <div class="stat-value">x<%= stats.prenotazioni_personali > 0 ? (stats.prenotazioni_totali / stats.prenotazioni_personali).toFixed(1) : '1.0' %></div>
                        <div class="stat-sublabel">Effetto leva del team</div>
                    </div>
                </div>
            </div>
            <% } %>

            <!-- Grafico Andamento -->
            <div class="chart-container">
                <h2 class="section-title">üìà Andamento Fatturato (Ultimi 6 Mesi)</h2>
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>

            <!-- Team Members -->
            <% if (stats.has_team) { %>
            <div class="team-section">
                <h2 class="section-title">üë• Il Tuo Team (<%= stats.numero_figli %> membri)</h2>
                <% if (sottoStaff && sottoStaff.length > 0) { %>
                    <% sottoStaff.forEach(member => { %>
                    <div class="team-member">
                        <div class="member-info">
                            <div class="member-name"><%= member.nickname %></div>
                            <div class="member-role"><%= member.ruolo.toUpperCase() %></div>
                        </div>
                        <div class="member-stats">
                            <div class="member-stat">
                                <div class="member-stat-value"><%= member.prenotazioni %></div>
                                <div class="member-stat-label">Prenotazioni</div>
                            </div>
                            <div class="member-stat">
                                <div class="member-stat-value">‚Ç¨<%= (member.fatturato || 0).toLocaleString() %></div>
                                <div class="member-stat-label">Fatturato</div>
                            </div>
                            <div class="member-stat">
                                <div class="member-stat-value">‚Ç¨<%= (member.provvigioni || 0).toLocaleString() %></div>
                                <div class="member-stat-label">Provvigioni</div>
                            </div>
                            <div class="member-stat">
                                <div class="member-stat-value"><%= member.persone_portate || 0 %></div>
                                <div class="member-stat-label">Persone</div>
                            </div>
                        </div>
                    </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-team">
                        <p>Non hai ancora membri nel tuo team.</p>
                    </div>
                <% } %>
            </div>
            <% } else { %>
            <div class="team-section">
                <h2 class="section-title">üë§ Modalit√† Individuale</h2>
                <div class="no-team">
                    <p>Stai operando in modalit√† individuale. Le statistiche mostrate rappresentano esclusivamente le tue performance personali.</p>
                </div>
            </div>
            <% } %>
        </div>
    </div>

    <script>
        // Configurazione Chart.js per il grafico del fatturato
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: <%- JSON.stringify(stats.mesi) %>,
                datasets: [{
                    label: '<% if (stats.has_team) { %>Fatturato Team<% } else { %>Fatturato Personale<% } %>',
                    data: <%- JSON.stringify(stats.fatturatoMensile) %>,
                    borderColor: '<% if (stats.has_team) { %>#4CAF50<% } else { %>#2196F3<% } %>',
                    backgroundColor: '<% if (stats.has_team) { %>rgba(76, 175, 80, 0.1)<% } else { %>rgba(33, 150, 243, 0.1)<% } %>',
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '<% if (stats.has_team) { %>#4CAF50<% } else { %>#2196F3<% } %>',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ‚Ç¨' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Ç¨' + value.toLocaleString();
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // Aggiorna il grafico ogni 30 secondi per riflettere eventuali nuovi dati
        setInterval(() => {
            // Qui si potrebbe implementare un aggiornamento in tempo reale
            // via AJAX se necessario
        }, 30000);
    </script>
</body>
</html>
