<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sotto-Staff | <%= pr.nickname %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/img/favicon.ico">
</head>
<body>
  <%- include('sidebar') %>
  
  <div class="main-content">
    <!-- Header Dashboard -->
    <div class="page-header">
      <h1>üìä Dashboard Sotto-Staff</h1>
      <div class="manager-info">
        <span class="manager-badge">üéØ Manager: <%= pr.nickname %></span>
        <% if (pr.poteri == 1) { %>
          <span class="power-badge">‚ö° Con Poteri</span>
        <% } %>
      </div>
    </div>

    <!-- Statistiche Totali del Sotto-Staff -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-title">Membri Sotto-Staff</div>
          <div class="stat-number"><%= statisticheTotali.totaleSottoStaff %></div>
          <div class="stat-subtitle">PR attivi</div>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <div class="stat-title">Persone Portate</div>
          <div class="stat-number"><%= statisticheTotali.totalePersonePortate %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-icon">üçΩÔ∏è</div>
        <div class="stat-content">
          <div class="stat-title">Tavoli Approvati</div>
          <div class="stat-number"><%= statisticheTotali.totaleTavoli %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <div class="stat-title">Performance</div>
          <div class="stat-number"><%= (statisticheTotali.totalePersonePortate / Math.max(statisticheTotali.totaleSottoStaff, 1)).toFixed(1) %></div>
          <div class="stat-subtitle">Media per PR</div>
        </div>
      </div>
    </div>

    <!-- Report Dettagliato Gerarchico -->
    <div class="section">
      <div class="section-header">
        <h2>üå≥ Struttura Gerarchica del Team</h2>
        <p class="section-description">Esplora la struttura del tuo sotto-staff con un albero espandibile</p>
      </div>

      <% if (sottoStaff.length === 0) { %>
        <div class="empty-state">
          <div class="empty-icon">üå±</div>
          <h3>Nessun sotto-staff presente</h3>
          <p>Il tuo team √® ancora in fase di crescita. I membri del sotto-staff appariranno qui una volta aggiunti.</p>
        </div>
      <% } else { %>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>üë§ Nome/Nickname</th>
                <th>üìä Livello</th>
                <th>üéØ Persone Portate</th>
                <th>üçΩÔ∏è Tavoli</th>
                <th>üìÖ Ultimo Accesso</th>
                <th>‚ö° Poteri</th>
              </tr>
            </thead>
            <tbody>
              <% 
                // Funzione per ordinare e strutturare i dati gerarchicamente
                function buildHierarchy(staff, parentId = null, level = 1) {
                  return staff
                    .filter(member => member.fk_padre === parentId)
                    .map(member => ({
                      ...member,
                      livello: level,
                      children: buildHierarchy(staff, member.id, level + 1)
                    }));
                }
                
                // Funzione per renderizzare ricorsivamente
                function renderMember(member, parentId = null) {
                  const hasChildren = member.children && member.children.length > 0;
                  const rowId = `member-${member.id}`;
                  const dataAttributes = parentId ? `data-parent-id="${parentId}"` : '';
                  const levelClass = `level-${member.livello}`;
                  
                  let html = `
                    <tr class="data-row ${levelClass} ${hasChildren ? 'has-children' : ''}" 
                        data-member-id="${member.id}" 
                        ${dataAttributes}
                        ${hasChildren ? `onclick="toggleChildren(${member.id})"` : ''}>
                      <td>
                        ${hasChildren ? `<span class="expand-icon" id="icon-${member.id}">‚ñ∂</span>` : '<span class="expand-icon hidden">‚óè</span>'}
                        <div class="user-info" style="margin-left: ${(member.livello - 1) * 20}px;">
                          <div class="user-avatar">${member.nickname.charAt(0).toUpperCase()}</div>
                          <div class="user-details">
                            <div class="user-name">${member.nickname}</div>
                            <div class="user-meta">ID: ${member.id}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="level-badge level-${member.livello}">
                          Livello ${member.livello}
                        </span>
                      </td>
                      <td>
                        <div class="metric-cell">
                          <span class="metric-value">${member.personePortate || 0}</span>
                          <span class="metric-icon">üë•</span>
                        </div>
                      </td>
                      <td>
                        <div class="metric-cell">
                          <span class="metric-value">${member.tavoli || 0}</span>
                          <span class="metric-icon">üçΩÔ∏è</span>
                        </div>
                      </td>
                      <td>
                        <span class="date-cell">
                          ${member.ultimo_accesso ? new Date(member.ultimo_accesso).toLocaleDateString('it-IT') : 'Mai'}
                        </span>
                      </td>
                      <td>
                        ${member.poteri == 1 ? '<span class="power-indicator active">‚ö° Attivi</span>' : '<span class="power-indicator inactive">‚ùå Inattivi</span>'}
                      </td>
                    </tr>
                  `;
                  
                  // Aggiungi ricorsivamente i figli
                  if (member.children) {
                    member.children.forEach(child => {
                      html += renderMember(child, member.id);
                    });
                  }
                  
                  return html;
                }
                
                const hierarchicalData = buildHierarchy(sottoStaff);
              %>
              
              <%- hierarchicalData.map(member => renderMember(member)).join('') %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>

    <!-- Sezione Organigramma Grafico -->
    <div class="section organigramma-section">
      <h2>üåê Organigramma del Sotto-Staff</h2>
      <p class="organigramma-subtitle">Visualizzazione interattiva della struttura gerarchica del tuo team</p>
      
      <!-- Controlli Organigramma -->
      <div class="organigramma-controls">
        <button class="control-btn active" id="viewHierarchy" data-mode="hierarchy">
          <i class="fas fa-sitemap"></i>
          <span>Vista Gerarchica</span>
        </button>
        <button class="control-btn" id="viewNetwork" data-mode="network">
          <i class="fas fa-project-diagram"></i>
          <span>Vista Rete</span>
        </button>
        <button class="control-btn" id="resetView">
          <i class="fas fa-refresh"></i>
          <span>Reset</span>
        </button>
      </div>
      
      <!-- Canvas Organigramma -->
      <div class="organigramma-container">
        <canvas id="organigramma-canvas"></canvas>
        
        <!-- Tooltip -->
        <div id="node-tooltip" class="node-tooltip">
          <div class="tooltip-header">
            <span class="tooltip-title"></span>
            <span class="tooltip-role"></span>
          </div>
          <div class="tooltip-content">
            <div class="tooltip-info"></div>
          </div>
        </div>
        
        <!-- Controlli zoom -->
        <div class="zoom-controls">
          <button class="zoom-btn" id="zoom-in">
            <i class="fas fa-plus"></i>
          </button>
          <button class="zoom-btn" id="zoom-out">
            <i class="fas fa-minus"></i>
          </button>
          <button class="zoom-btn" id="zoom-fit">
            <i class="fas fa-expand-arrows-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .manager-info {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .manager-badge, .power-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .power-badge {
      background: rgba(255, 215, 0, 0.3);
      border-color: rgba(255, 215, 0, 0.5);
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      padding: 0 30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border-left: 5px solid #667eea;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-card.primary { border-left-color: #667eea; }
    .stat-card.success { border-left-color: #00b894; }
    .stat-card.warning { border-left-color: #fdcb6e; }
    .stat-card.info { border-left-color: #74b9ff; }

    .stat-icon {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea20, #764ba220);
      border-radius: 50%;
    }

    .stat-content {
      flex: 1;
    }

    .stat-title {
      font-size: 0.9rem;
      color: #636e72;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .stat-number {
      font-size: 2.2rem;
      font-weight: bold;
      color: #2d3436;
      margin-bottom: 2px;
    }

    .stat-subtitle {
      font-size: 0.8rem;
      color: #b2bec3;
    }

    .section {
      background: white;
      margin: 0 30px 30px;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .section-header {
      margin-bottom: 25px;
    }

    .section-header h2 {
      font-size: 1.8rem;
      color: #2d3436;
      margin-bottom: 8px;
    }

    .section-description {
      color: #636e72;
      font-size: 1rem;
    }

    .empty-state {
      text-align: center;
      padding: 50px 20px;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #2d3436;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #636e72;
      max-width: 400px;
      margin: 0 auto;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .data-table th {
      background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      border-bottom: 1px solid #ddd;
    }

    .data-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    .data-row {
      transition: background-color 0.2s ease;
    }

    .data-row:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .data-row.has-children {
      cursor: pointer;
    }

    .data-row.has-children:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .expand-icon {
      margin-right: 8px;
      transition: transform 0.2s ease;
      color: #667eea;
      font-weight: bold;
      font-size: 0.8rem;
      display: inline-block;
      width: 12px;
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .expand-icon.hidden {
      visibility: hidden;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1rem;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      color: #2d3436;
      margin-bottom: 2px;
    }

    .user-meta {
      font-size: 0.8rem;
      color: #b2bec3;
    }

    .level-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .level-badge.level-1 {
      background: #00b89420;
      color: #00b894;
      border: 1px solid #00b89440;
    }

    .level-badge.level-2 {
      background: #74b9ff20;
      color: #74b9ff;
      border: 1px solid #74b9ff40;
    }

    .level-badge.level-3 {
      background: #fdcb6e20;
      color: #fdcb6e;
      border: 1px solid #fdcb6e40;
    }

    .metric-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-value {
      font-weight: 600;
      color: #2d3436;
    }

    .metric-icon {
      font-size: 1.1rem;
    }

    .date-cell {
      color: #636e72;
      font-size: 0.9rem;
    }

    .power-indicator {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .power-indicator.active {
      background: #00b89420;
      color: #00b894;
    }

    .power-indicator.inactive {
      background: #e1747420;
      color: #e17474;
    }

    /* CSS Organigramma */
    .organigramma-section {
      margin-top: 40px;
    }

    .organigramma-subtitle {
      color: #636e72;
      font-size: 1.1rem;
      margin-bottom: 25px;
    }

    .organigramma-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .control-btn:hover {
      border-color: #667eea;
      color: #667eea;
      transform: translateY(-2px);
    }

    .control-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .organigramma-container {
      position: relative;
      width: 100%;
      height: 600px;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      background: #fafafa;
    }

    #organigramma-canvas {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #organigramma-canvas:active {
      cursor: grabbing;
    }

    .node-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      max-width: 300px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .tooltip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
    }

    .tooltip-title {
      font-weight: bold;
      font-size: 1rem;
    }

    .tooltip-role {
      background: rgba(102, 126, 234, 0.8);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .tooltip-content {
      line-height: 1.4;
    }

    .zoom-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .zoom-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #636e72;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .zoom-btn:hover {
      background: white;
      color: #667eea;
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .manager-info {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .organigramma-controls {
        justify-content: center;
      }
      
      .control-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .organigramma-container {
        height: 400px;
      }
    }
  </style>

  <!-- Dati per l'organigramma -->
  <script>
    window.sottoStaffData = <%- JSON.stringify(sottoStaff) %>;
  </script>

  <script>
    function toggleChildren(parentId) {
      const icon = document.getElementById(`icon-${parentId}`);
      const rows = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      // Determina se espandere o contrarre
      const isExpanded = icon.classList.contains('expanded');
      
      if (isExpanded) {
        // Contrarre: nascondi tutti i figli e sottosottostanti
        collapseAllDescendants(parentId);
        icon.classList.remove('expanded');
        icon.textContent = '‚ñ∂';
      } else {
        // Espandere: mostra solo i figli diretti
        rows.forEach(row => {
          row.style.display = 'table-row';
        });
        icon.classList.add('expanded');
        icon.textContent = '‚ñº';
      }
    }

    function collapseAllDescendants(parentId) {
      const directChildren = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      directChildren.forEach(child => {
        child.style.display = 'none';
        
        // Chiudi anche le frecce dei figli
        const childId = child.getAttribute('data-member-id');
        const childIcon = document.getElementById(`icon-${childId}`);
        if (childIcon) {
          childIcon.classList.remove('expanded');
          childIcon.textContent = '‚ñ∂';
        }
        
        // Ricorsivamente chiudi tutti i discendenti
        collapseAllDescendants(childId);
      });
    }

    // Inizializzazione: mostra solo il primo livello
    document.addEventListener('DOMContentLoaded', function() {
      // Nascondi tutti i livelli superiori al primo
      const rows = document.querySelectorAll('.data-row');
      rows.forEach(row => {
        if (row.classList.contains('level-2') || 
            row.classList.contains('level-3') || 
            row.classList.contains('level-4') || 
            row.classList.contains('level-5')) {
          row.style.display = 'none';
        }
      });

      // Inizializza l'organigramma
      initOrganigramma();
    });

    // Sistema Organigramma
    let canvas, ctx, nodes = [], links = [], simulation;
    let transform = { x: 0, y: 0, scale: 1 };
    let isDragging = false, dragStart = { x: 0, y: 0 };
    let currentMode = 'hierarchy';
    let selectedNode = null;

    function initOrganigramma() {
      canvas = document.getElementById('organigramma-canvas');
      if (!canvas) return;
      
      ctx = canvas.getContext('2d');
      
      // Imposta dimensioni canvas
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Crea dati per l'organigramma
      createOrganigrammaData();
      
      // Eventi controlli
      setupControls();
      
      // Eventi canvas
      setupCanvasEvents();
      
      // Avvia animazione
      animate();
    }

    function resizeCanvas() {
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }

    function createOrganigrammaData() {
      nodes = [];
      links = [];
      
      // Usa i dati reali del sotto-staff
      const staffData = window.sottoStaffData || [];
      
      staffData.forEach(member => {
        nodes.push({
          id: member.id,
          name: member.nickname,
          role: 'PR',
          level: member.livello || 1,
          personePortate: member.personePortate || 0,
          tavoli: member.tavoli || 0,
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: 0,
          vy: 0,
          fx: null,
          fy: null,
          radius: Math.max(20, Math.min(40, 20 + (member.personePortate || 0) * 0.5))
        });
        
        // Crea link se ha un padre
        if (member.fk_padre) {
          links.push({
            source: member.fk_padre,
            target: member.id,
            strength: 0.8
          });
        }
      });
      
      // Se non ci sono dati, crea un nodo placeholder
      if (nodes.length === 0) {
        nodes.push({
          id: 'placeholder',
          name: 'Nessun sotto-staff',
          role: 'INFO',
          level: 1,
          personePortate: 0,
          tavoli: 0,
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: 0,
          vy: 0,
          fx: canvas.width / 2,
          fy: canvas.height / 2,
          radius: 30
        });
      }
      
      updateLayout();
    }

    function updateLayout() {
      if (currentMode === 'hierarchy') {
        layoutHierarchy();
      } else {
        layoutNetwork();
      }
    }

    function layoutHierarchy() {
      const levels = {};
      nodes.forEach(node => {
        if (!levels[node.level]) levels[node.level] = [];
        levels[node.level].push(node);
      });
      
      const levelHeight = canvas.height / (Object.keys(levels).length + 1);
      
      Object.keys(levels).forEach((level, levelIndex) => {
        const nodesInLevel = levels[level];
        const nodeWidth = canvas.width / (nodesInLevel.length + 1);
        
        nodesInLevel.forEach((node, nodeIndex) => {
          node.fx = nodeWidth * (nodeIndex + 1);
          node.fy = levelHeight * (levelIndex + 1);
          node.x = node.fx;
          node.y = node.fy;
        });
      });
    }

    function layoutNetwork() {
      nodes.forEach(node => {
        node.fx = null;
        node.fy = null;
      });
    }

    function setupControls() {
      document.getElementById('viewHierarchy')?.addEventListener('click', () => {
        setMode('hierarchy');
      });
      
      document.getElementById('viewNetwork')?.addEventListener('click', () => {
        setMode('network');
      });
      
      document.getElementById('resetView')?.addEventListener('click', () => {
        resetView();
      });
      
      document.getElementById('zoom-in')?.addEventListener('click', () => {
        zoom(1.2);
      });
      
      document.getElementById('zoom-out')?.addEventListener('click', () => {
        zoom(0.8);
      });
      
      document.getElementById('zoom-fit')?.addEventListener('click', () => {
        fitToScreen();
      });
    }

    function setMode(mode) {
      currentMode = mode;
      
      // Aggiorna bottoni
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`)?.classList.add('active');
      
      updateLayout();
    }

    function resetView() {
      transform = { x: 0, y: 0, scale: 1 };
    }

    function zoom(factor) {
      transform.scale *= factor;
      transform.scale = Math.max(0.1, Math.min(3, transform.scale));
    }

    function fitToScreen() {
      if (nodes.length === 0) return;
      
      let minX = Infinity, maxX = -Infinity;
      let minY = Infinity, maxY = -Infinity;
      
      nodes.forEach(node => {
        minX = Math.min(minX, node.x - node.radius);
        maxX = Math.max(maxX, node.x + node.radius);
        minY = Math.min(minY, node.y - node.radius);
        maxY = Math.max(maxY, node.y + node.radius);
      });
      
      const width = maxX - minX;
      const height = maxY - minY;
      const scale = Math.min(canvas.width / width, canvas.height / height) * 0.8;
      
      transform.scale = scale;
      transform.x = (canvas.width - (minX + maxX) * scale) / 2;
      transform.y = (canvas.height - (minY + maxY) * scale) / 2;
    }

    function setupCanvasEvents() {
      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      canvas.addEventListener('wheel', onWheel);
      canvas.addEventListener('mouseleave', hideTooltip);
    }

    function onMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const node = getNodeAt(x, y);
      if (node) {
        selectedNode = node;
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      } else {
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      }
    }

    function onMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      if (isDragging) {
        if (selectedNode) {
          const worldX = (x - transform.x) / transform.scale;
          const worldY = (y - transform.y) / transform.scale;
          selectedNode.fx = worldX;
          selectedNode.fy = worldY;
          selectedNode.x = worldX;
          selectedNode.y = worldY;
        } else {
          transform.x = x - dragStart.x;
          transform.y = y - dragStart.y;
        }
      } else {
        const node = getNodeAt(x, y);
        if (node) {
          showTooltip(node, x, y);
          canvas.style.cursor = 'pointer';
        } else {
          hideTooltip();
          canvas.style.cursor = 'grab';
        }
      }
    }

    function onMouseUp() {
      isDragging = false;
      selectedNode = null;
    }

    function onWheel(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = transform.scale * factor;
      
      if (newScale >= 0.1 && newScale <= 3) {
        transform.x = x - (x - transform.x) * factor;
        transform.y = y - (y - transform.y) * factor;
        transform.scale = newScale;
      }
    }

    function getNodeAt(x, y) {
      const worldX = (x - transform.x) / transform.scale;
      const worldY = (y - transform.y) / transform.scale;
      
      return nodes.find(node => {
        const dx = worldX - node.x;
        const dy = worldY - node.y;
        return Math.sqrt(dx * dx + dy * dy) <= node.radius;
      });
    }

    function showTooltip(node, x, y) {
      const tooltip = document.getElementById('node-tooltip');
      if (!tooltip) return;
      
      tooltip.querySelector('.tooltip-title').textContent = node.name;
      tooltip.querySelector('.tooltip-role').textContent = node.role;
      tooltip.querySelector('.tooltip-info').innerHTML = `
        <div>üë• Persone portate: ${node.personePortate}</div>
        <div>üçΩÔ∏è Tavoli: ${node.tavoli}</div>
        <div>üìä Livello: ${node.level}</div>
      `;
      
      tooltip.style.left = x + 10 + 'px';
      tooltip.style.top = y - 10 + 'px';
      tooltip.style.opacity = '1';
    }

    function hideTooltip() {
      const tooltip = document.getElementById('node-tooltip');
      if (tooltip) {
        tooltip.style.opacity = '0';
      }
    }

    function animate() {
      draw();
      requestAnimationFrame(animate);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.save();
      ctx.translate(transform.x, transform.y);
      ctx.scale(transform.scale, transform.scale);
      
      // Disegna link
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 2;
      links.forEach(link => {
        const source = nodes.find(n => n.id === link.source);
        const target = nodes.find(n => n.id === link.target);
        if (source && target) {
          ctx.beginPath();
          ctx.moveTo(source.x, source.y);
          ctx.lineTo(target.x, target.y);
          ctx.stroke();
        }
      });
      
      // Disegna nodi
      nodes.forEach(node => {
        // Cerchio esterno
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.radius, 0, 2 * Math.PI);
        ctx.fillStyle = node.id === 'placeholder' ? '#bbb' : '#667eea';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Testo
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${Math.max(10, node.radius * 0.3)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(node.name.substring(0, 8), node.x, node.y);
      });
      
      ctx.restore();
    }
  </script>

</body>
</html>
