<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sotto-Staff | <%= pr.nickname %></title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/img/favicon.ico">
</head>
<body>
  <%- include('sidebar') %>
  
  <div class="main-content">
    <!-- Header Dashboard -->
    <div class="page-header">
      <h1>üìä Dashboard Sotto-Staff</h1>
      <div class="manager-info">
        <span class="manager-badge">üéØ Manager: <%= pr.nickname %></span>
        <% if (pr.poteri == 1) { %>
          <span class="power-badge">‚ö° Con Poteri</span>
        <% } %>
      </div>
    </div>

    <!-- Statistiche Totali del Sotto-Staff -->
    <div class="stats-overview">
      <div class="stat-card primary">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-title">Membri Sotto-Staff</div>
          <div class="stat-number"><%= statisticheTotali.totaleSottoStaff %></div>
          <div class="stat-subtitle">PR attivi</div>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <div class="stat-title">Persone Portate</div>
          <div class="stat-number"><%= statisticheTotali.totalePersonePortate %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-icon">üçΩÔ∏è</div>
        <div class="stat-content">
          <div class="stat-title">Tavoli Approvati</div>
          <div class="stat-number"><%= statisticheTotali.totaleTavoli %></div>
          <div class="stat-subtitle">Totale storico</div>
        </div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-title">Provvigioni Totali</div>
          <div class="stat-number">‚Ç¨<%= statisticheTotali.totaleProvvigioni.toFixed(2) %></div>
          <div class="stat-subtitle">Da pagare</div>
        </div>
      </div>
      
      <div class="stat-card secondary">
        <div class="stat-icon">üíé</div>
        <div class="stat-content">
          <div class="stat-title">Valore Storico</div>
          <div class="stat-number">‚Ç¨<%= statisticheTotali.totaleValoreStorico.toFixed(2) %></div>
          <div class="stat-subtitle">Totale da sempre</div>
        </div>
      </div>
    </div>

    <!-- Tabella Dettagliata del Sotto-Staff -->
    <% if (reportData && reportData.length > 0) { %>
    <div class="section">
      <h2>üìã Report Dettagliato del Sotto-Staff</h2>
      
      <div class="table-container">
        <table class="report-table">
          <thead>
            <tr>
              <th>üë§ Utente</th>
              <th>üè∑Ô∏è Ruolo</th>
              <th>üë§ Padre</th>
              <th>üíº % Prov.</th>
              <th>‚ö° Poteri</th>
              <th>üéØ Persone (Totali)</th>
              <th>üçΩÔ∏è Tavoli (Totali)</th>
              <th>üí∞ Provvigioni da Pagare</th>
              <th>üìä Totale Storico</th>
            </tr>
          </thead>
          <tbody>
            <% reportData.forEach(member => { %>
            <tr class="data-row level-<%= member.livello %>" data-member-id="<%= member.id %>" data-parent-id="<%= member.fk_padre || 'root' %>">
              <td class="user-cell">
                <div class="user-info" style="margin-left: <%= (member.livello - 1) * 20 %>px;">
                  <% if (member.has_children) { %>
                    <span class="expand-icon" onclick="toggleChildren('<%= member.id %>')" id="icon-<%= member.id %>">‚ñ∂</span>
                  <% } else { %>
                    <span class="no-children-icon">‚Ä¢</span>
                  <% } %>
                  <div class="user-details-inline">
                    <div class="user-nickname"><%= member.nickname %></div>
                    <div class="user-details"><%= member.nome %> <%= member.cognome %></div>
                  </div>
                </div>
              </td>
              <td>
                <span class="role-badge pr">PR</span>
                <% if (member.livello > 1) { %>
                  <div class="level-badge">Livello <%= member.livello %></div>
                <% } %>
              </td>
              <td>
                <span class="parent-info">üëÜ <%= member.padre_nickname %></span>
              </td>
              <td>
                <% if (member.percentuale_provvigione != null) { %>
                  <span class="percentage"><%= member.percentuale_provvigione %>%</span>
                <% } else { %>
                  <span class="no-data">-</span>
                <% } %>
              </td>
              <td>
                <span class="powers <%= member.poteri == 1 ? 'enabled' : 'disabled' %>">
                  <%= member.poteri == 1 ? '‚úÖ SI' : '‚ùå NO' %>
                </span>
              </td>
              <td class="stat-cell">
                <span class="main-stat"><%= member.totale_storico_persone %></span>
              </td>
              <td class="stat-cell">
                <span class="main-stat"><%= member.count_storico_tavoli %></span>
              </td>
              <td class="stat-cell">
                <span class="money">‚Ç¨<%= member.provvigioni_guadagnate.toFixed(2) %></span>
              </td>
              <td class="stat-cell">
                <div class="historic-stats">
                  <div>üë• <%= member.totale_storico_persone %> persone</div>
                  <div>üçΩÔ∏è <%= member.count_storico_tavoli %> tavoli</div>
                  <div class="money">üí∞ ‚Ç¨<%= member.totale_storico_valore.toFixed(2) %></div>
                </div>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <% } else { %>
    <!-- Messaggio quando non ci sono membri nel sotto-staff -->
    <div class="empty-state">
      <div class="empty-icon">üë•</div>
      <h3>Nessun membro nel sotto-staff</h3>
      <p>Non hai ancora collaboratori sotto di te. Quando avrai dei PR nel tuo team, i loro dati appariranno qui.</p>
    </div>
    <% } %>

    <!-- Sezione Organigramma Grafico -->
    <div class="section organigramma-section">
      <div class="organigramma-header">
        <h2>üåê Organigramma Interattivo del Sotto-Staff</h2>
        <div class="current-manager">
          <div class="manager-node">
            <div class="manager-avatar">
              <%= pr.nickname.charAt(0).toUpperCase() %>
            </div>
            <div class="manager-details">
              <div class="manager-name"><%= pr.nickname %></div>
              <div class="manager-role">üëë Manager Principale</div>
            </div>
          </div>
        </div>
      </div>
      
      <p class="organigramma-subtitle">Esplora la struttura gerarchica del tuo team con visualizzazioni interattive avanzate</p>
      
      <!-- Controlli Organigramma Migliorati -->
      <div class="organigramma-controls">
        <div class="control-group">
          <label class="control-label">üé® Modalit√† Visualizzazione:</label>
          <div class="control-buttons">
            <button class="control-btn" id="viewTree" data-mode="tree">
              <i class="fas fa-tree"></i>
              <span>Albero</span>
            </button>
            <button class="control-btn active" id="viewHierarchy" data-mode="hierarchy">
              <i class="fas fa-sitemap"></i>
              <span>Gerarchica</span>
            </button>
            <button class="control-btn" id="viewNetwork" data-mode="network">
              <i class="fas fa-project-diagram"></i>
              <span>Rete</span>
            </button>
            <button class="control-btn" id="viewCircular" data-mode="circular">
              <i class="fas fa-circle-notch"></i>
              <span>Circolare</span>
            </button>
          </div>
        </div>
        
        <div class="control-group">
          <label class="control-label">üîß Azioni:</label>
          <div class="control-buttons">
            <button class="control-btn secondary" id="resetView">
              <i class="fas fa-refresh"></i>
              <span>Reset Vista</span>
            </button>
            <button class="control-btn secondary" id="centerView">
              <i class="fas fa-crosshairs"></i>
              <span>Centra</span>
            </button>
            <button class="control-btn secondary" id="fullscreen">
              <i class="fas fa-expand"></i>
              <span>Schermo Intero</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Informazioni Struttura -->
      <div class="structure-info">
        <div class="info-card">
          <div class="info-icon">üå≥</div>
          <div class="info-content">
            <div class="info-title">Livelli Gerarchici</div>
            <div class="info-value" id="hierarchyLevels">-</div>
          </div>
        </div>
        <div class="info-card">
          <div class="info-icon">üîó</div>
          <div class="info-content">
            <div class="info-title">Connessioni</div>
            <div class="info-value" id="connectionCount">-</div>
          </div>
        </div>
      </div>
      
      <!-- Canvas Organigramma Migliorato -->
      <div class="organigramma-container enhanced">
        <canvas id="organigramma-canvas"></canvas>
        
        <!-- Legenda -->
        <div class="organigramma-legend">
          <div class="legend-item">
            <div class="legend-node manager"></div>
            <span>Manager</span>
          </div>
          <div class="legend-item">
            <div class="legend-node pr-high"></div>
            <span>PR Alto Rendimento</span>
          </div>
          <div class="legend-item">
            <div class="legend-node pr-normal"></div>
            <span>PR Standard</span>
          </div>
          <div class="legend-item">
            <div class="legend-node pr-new"></div>
            <span>PR Nuovo</span>
          </div>
        </div>
        
        <!-- Tooltip Migliorato -->
        <div id="node-tooltip" class="node-tooltip enhanced">
          <div class="tooltip-header">
            <div class="tooltip-avatar"></div>
            <div class="tooltip-title-section">
              <span class="tooltip-title"></span>
              <span class="tooltip-role"></span>
            </div>
          </div>
          <div class="tooltip-content">
            <div class="tooltip-stats">
              <div class="stat-item">
                <i class="fas fa-users"></i>
                <span class="stat-label">Persone:</span>
                <span class="stat-value" id="tooltip-persone">0</span>
              </div>
              <div class="stat-item">
                <i class="fas fa-utensils"></i>
                <span class="stat-label">Tavoli:</span>
                <span class="stat-value" id="tooltip-tavoli">0</span>
              </div>
              <div class="stat-item">
                <i class="fas fa-layer-group"></i>
                <span class="stat-label">Livello:</span>
                <span class="stat-value" id="tooltip-livello">1</span>
              </div>
              <div class="stat-item">
                <i class="fas fa-bolt"></i>
                <span class="stat-label">Poteri:</span>
                <span class="stat-value" id="tooltip-poteri">No</span>
              </div>
            </div>
            <div class="tooltip-performance">
              <div class="performance-bar">
                <div class="performance-fill" id="tooltip-performance-bar"></div>
              </div>
              <span class="performance-text" id="tooltip-performance-text">Performance</span>
            </div>
          </div>
        </div>
        
        <!-- Controlli zoom migliorati -->
        <div class="zoom-controls enhanced">
          <button class="zoom-btn" id="zoom-in" title="Zoom In">
            <i class="fas fa-plus"></i>
          </button>
          <button class="zoom-btn" id="zoom-out" title="Zoom Out">
            <i class="fas fa-minus"></i>
          </button>
          <button class="zoom-btn" id="zoom-fit" title="Adatta alla Vista">
            <i class="fas fa-expand-arrows-alt"></i>
          </button>
          <div class="zoom-level">
            <span id="zoom-percentage">100%</span>
          </div>
        </div>
        
        <!-- Mini Mappa -->
        <div class="minimap">
          <canvas id="minimap-canvas"></canvas>
          <div class="minimap-viewport"></div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Stili specifici per la dashboard sotto-staff */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e9ecef;
    }

    .manager-info {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .manager-badge {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .power-badge {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .stat-card.primary { border-left-color: #007bff; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.info { border-left-color: #17a2b8; }
    .stat-card.secondary { border-left-color: #6c757d; }

    .stat-icon {
      font-size: 2rem;
      opacity: 0.8;
    }

    .stat-content {
      flex: 1;
    }

    .stat-title {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.25rem;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: #212529;
      margin-bottom: 0.25rem;
    }

    .stat-subtitle {
      font-size: 0.75rem;
      color: #6c757d;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 2rem 0;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      color: #6c757d;
      margin-bottom: 1rem;
    }

    .empty-state p {
      color: #868e96;
      max-width: 500px;
      margin: 0 auto 1rem;
    }

    /* Stili per la tabella report */
    .section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      margin-bottom: 1.5rem;
      color: #495057;
    }

    .table-container {
      overflow-x: auto;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .report-table th {
      background: #f8f9fa;
      padding: 1rem 0.75rem;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }

    .report-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }

    .data-row:hover {
      background: #f8f9fa;
    }

    .user-cell {
      min-width: 150px;
    }

    .user-nickname {
      font-weight: 600;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .indent {
      color: #6c757d;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .level-indicator {
      color: #17a2b8;
      font-family: monospace;
      font-weight: bold;
    }

    .level-badge {
      font-size: 0.7rem;
      color: #6c757d;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 8px;
      margin-top: 0.25rem;
      display: inline-block;
    }

    /* Colorazione diversa per livelli diversi */
    .data-row[data-level="1"] {
      background: rgba(0, 123, 255, 0.02);
    }

    .data-row[data-level="2"] {
      background: rgba(40, 167, 69, 0.02);
    }

    .data-row[data-level="3"] {
      background: rgba(255, 193, 7, 0.02);
    }

    .data-row[data-level="4"] {
      background: rgba(220, 53, 69, 0.02);
    }

    .user-details {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .role-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-badge.pr {
      background: #e3f2fd;
      color: #1976d2;
    }

    .parent-info {
      color: #6c757d;
      font-size: 0.85rem;
    }

    .percentage {
      font-weight: 600;
      color: #17a2b8;
    }

    .powers.enabled {
      color: #28a745;
      font-weight: 600;
    }

    .powers.disabled {
      color: #dc3545;
      font-weight: 600;
    }

    .stat-cell {
      text-align: center;
    }

    .main-stat {
      font-weight: 700;
      font-size: 1.1rem;
      color: #495057;
    }

    .money {
      color: #28a745;
      font-weight: 700;
    }

    .historic-stats {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .historic-stats div {
      margin-bottom: 0.25rem;
    }

    .no-data {
      color: #6c757d;
      font-style: italic;
    }

    /* Stili per le frecce espandibili */
    .expand-icon {
      cursor: pointer;
      font-size: 1rem;
      margin-right: 8px;
      transition: transform 0.2s ease;
      color: #007bff;
      font-weight: bold;
      display: inline-block;
      width: 16px;
      text-align: center;
    }

    .expand-icon:hover {
      color: #0056b3;
      transform: scale(1.2);
    }

    .expand-icon.expanded {
      transform: rotate(90deg);
    }

    .no-children-icon {
      color: #6c757d;
      font-size: 0.8rem;
      margin-right: 8px;
      display: inline-block;
      width: 16px;
      text-align: center;
    }

    .user-details-inline {
      display: inline-block;
      vertical-align: middle;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    /* Nascondi inizialmente tutti i livelli > 1 */
    .data-row.level-2,
    .data-row.level-3,
    .data-row.level-4,
    .data-row.level-5 {
      display: none;
    }

    /* Mostra solo i livelli 1 inizialmente */
    .data-row.level-1 {
      display: table-row;
    }

    @media (max-width: 768px) {
      .stats-overview {
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 2rem;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .manager-info {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .controls-panel {
        padding: 15px;
        margin: 10px 10px 2rem 10px; /* Aggiungi margin-bottom */
      }
      
      .control-group {
        margin-bottom: 15px;
      }
      
      .control-buttons {
        gap: 8px;
      }
      
      .control-btn {
        min-width: 80px;
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      .organigramma-canvas-container {
        margin: 10px 10px 2rem 10px; /* Aggiungi margin-bottom */
        height: 400px;
      }
      
      #organigramma-canvas {
        height: 400px;
      }
      
      .legend {
        padding: 10px;
        font-size: 0.8rem;
        margin-bottom: 2rem;
      }
      
      .legend-item {
        font-size: 0.75rem;
      }
      
      .table-container {
        margin-bottom: 3rem; /* Spazio extra per la tabella */
      }
      
      /* Assicura spazio per il contenuto */
      body {
        padding-bottom: 3rem !important;
      }
    }
    
    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.5rem;
      }
      
      .controls-panel {
        padding: 10px;
        margin: 5px 5px 3rem 5px; /* Ancora pi√π margin-bottom */
      }
      
      .control-btn {
        min-width: 60px;
        padding: 6px 8px;
        font-size: 0.75rem;
      }
      
      .control-btn span {
        display: none;
      }
      
      .control-btn i {
        font-size: 1rem;
      }
      
      .organigramma-canvas-container {
        margin: 5px 5px 3rem 5px; /* Ancora pi√π margin-bottom */
        height: 300px;
      }
      
      #organigramma-canvas {
        height: 300px;
      }
      
      .stats-overview {
        gap: 10px;
        margin-bottom: 3rem;
      }
      
      .stat-item h3 {
        font-size: 1.2rem;
      }
      
      .stat-item p {
        font-size: 0.8rem;
      }
      
      .legend {
        padding: 8px;
        font-size: 0.7rem;
        margin-bottom: 3rem;
      }
      
      .legend-item {
        font-size: 0.65rem;
      }
      
      .table-container {
        margin: 5px 5px 4rem 5px; /* Ancora pi√π spazio */
      }
      
      .staff-table th,
      .staff-table td {
        padding: 6px 4px;
        font-size: 0.7rem;
      }
      
      /* Ancora pi√π spazio per mobile piccoli */
      body {
        padding-bottom: 4rem !important;
      }
    }

    /* CSS Organigramma Migliorato */
    .organigramma-section {
      margin-top: 40px;
    }

    .organigramma-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .current-manager {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .manager-node {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .manager-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .manager-details {
      color: white;
    }

    .manager-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .manager-role {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .organigramma-subtitle {
      color: #636e72;
      font-size: 1.1rem;
      margin-bottom: 25px;
      text-align: center;
    }

    .organigramma-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 25px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      border: 1px solid #e9ecef;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-label {
      font-weight: 600;
      color: #495057;
      font-size: 0.9rem;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 2px solid #dee2e6;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
      min-width: 100px;
      justify-content: center;
    }

    .control-btn:hover {
      border-color: #667eea;
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .control-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .control-btn.secondary {
      border-color: #6c757d;
      color: #6c757d;
    }

    .control-btn.secondary:hover {
      border-color: #495057;
      color: #495057;
    }

    .structure-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .info-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .info-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .info-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea20, #764ba220);
      border-radius: 50%;
    }

    .info-content {
      flex: 1;
    }

    .info-title {
      font-size: 0.8rem;
      color: #6c757d;
      margin-bottom: 2px;
    }

    .info-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: #495057;
    }

    .organigramma-container.enhanced {
      position: relative;
      width: 100%;
      height: 700px;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    #organigramma-canvas {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #organigramma-canvas:active {
      cursor: grabbing;
    }

    .organigramma-legend {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #495057;
    }

    .legend-item:last-child {
      margin-bottom: 0;
    }

    .legend-node {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .legend-node.manager {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .legend-node.pr-high {
      background: linear-gradient(135deg, #00b894, #00cec9);
    }

    .legend-node.pr-normal {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
    }

    .legend-node.pr-new {
      background: linear-gradient(135deg, #fd79a8, #e84393);
    }

    .node-tooltip.enhanced {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px;
      border-radius: 15px;
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
      max-width: 350px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    .tooltip-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 12px;
    }

    .tooltip-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .tooltip-title-section {
      flex: 1;
    }

    .tooltip-title {
      font-weight: bold;
      font-size: 1.1rem;
      display: block;
      margin-bottom: 3px;
    }

    .tooltip-role {
      background: rgba(102, 126, 234, 0.8);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      display: inline-block;
    }

    .tooltip-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    .stat-item i {
      width: 16px;
      color: #667eea;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.8);
    }

    .stat-value {
      font-weight: bold;
      color: white;
    }

    .tooltip-performance {
      margin-top: 10px;
    }

    .performance-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .performance-fill {
      height: 100%;
      background: linear-gradient(90deg, #00b894, #00cec9);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .performance-text {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .zoom-controls.enhanced {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .zoom-btn {
      width: 45px;
      height: 45px;
      border: none;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: #495057;
      transition: all 0.3s ease;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .zoom-btn:hover {
      background: white;
      color: #667eea;
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }

    .zoom-level {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 8px 12px;
      text-align: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: #495057;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .minimap {
      position: absolute;
      bottom: 15px;
      right: 15px;
      width: 150px;
      height: 100px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      overflow: hidden;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    #minimap-canvas {
      width: 100%;
      height: 100%;
    }

    .minimap-viewport {
      position: absolute;
      border: 2px solid #667eea;
      background: rgba(102, 126, 234, 0.2);
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .organigramma-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-buttons {
        justify-content: center;
      }
      
      .control-btn {
        min-width: 80px;
        padding: 8px 12px;
        font-size: 0.8rem;
      }
      
      .organigramma-container.enhanced {
        height: 500px;
      }
      
      .structure-info {
        grid-template-columns: 1fr;
      }
      
      .minimap {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .organigramma-controls {
        justify-content: center;
      }
      
      .control-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .organigramma-container {
        height: 400px;
      }
    }
  </style>

  <!-- Dati per l'organigramma -->
  <script>
    window.sottoStaffData = <%- JSON.stringify(sottoStaff) %>;
  </script>

  <script>
    function toggleChildren(parentId) {
      const icon = document.getElementById(`icon-${parentId}`);
      const rows = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      // Determina se espandere o contrarre
      const isExpanded = icon.classList.contains('expanded');
      
      if (isExpanded) {
        // Contrarre: nascondi tutti i figli e sottosottostanti
        collapseAllDescendants(parentId);
        icon.classList.remove('expanded');
        icon.textContent = '‚ñ∂';
      } else {
        // Espandere: mostra solo i figli diretti
        rows.forEach(row => {
          row.style.display = 'table-row';
        });
        icon.classList.add('expanded');
        icon.textContent = '‚ñº';
      }
    }

    function collapseAllDescendants(parentId) {
      const directChildren = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
      
      directChildren.forEach(child => {
        child.style.display = 'none';
        
        // Chiudi anche le frecce dei figli
        const childId = child.getAttribute('data-member-id');
        const childIcon = document.getElementById(`icon-${childId}`);
        if (childIcon) {
          childIcon.classList.remove('expanded');
          childIcon.textContent = '‚ñ∂';
        }
        
        // Ricorsivamente chiudi tutti i discendenti
        collapseAllDescendants(childId);
      });
    }

    // Inizializzazione: mostra solo il primo livello
    document.addEventListener('DOMContentLoaded', function() {
      // Nascondi tutti i livelli superiori al primo
      const rows = document.querySelectorAll('.data-row');
      rows.forEach(row => {
        if (row.classList.contains('level-2') || 
            row.classList.contains('level-3') || 
            row.classList.contains('level-4') || 
            row.classList.contains('level-5')) {
          row.style.display = 'none';
        }
      });

      // Inizializza l'organigramma
      initOrganigramma();
    });

    // Sistema Organigramma
    let canvas, ctx, nodes = [], links = [], simulation;
    let transform = { x: 0, y: 0, scale: 1 };
    let isDragging = false, dragStart = { x: 0, y: 0 };
    let currentMode = 'hierarchy';
    let selectedNode = null;

    function initOrganigramma() {
      console.log('Inizializzazione organigramma...');
      canvas = document.getElementById('organigramma-canvas');
      if (!canvas) {
        console.error('Canvas organigramma non trovato!');
        return;
      }
      
      ctx = canvas.getContext('2d');
      console.log('Canvas trovato e contesto inizializzato');
      
      // Imposta dimensioni canvas
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Crea dati per l'organigramma
      createOrganigrammaData();
      
      // Eventi controlli
      setupControls();
      
      // Eventi canvas
      setupCanvasEvents();
      
      // Avvia animazione
      animate();
    }

    function resizeCanvas() {
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }

    function createOrganigrammaData() {
      nodes = [];
      links = [];
      
      // ID del manager (usa stringa per evitare problemi)
      const managerId = 'manager';
      
      // Aggiungi il nodo manager
      nodes.push({
        id: managerId,
        name: '<%= pr.nickname %>',
        role: 'MANAGER',
        level: 0,
        personePortate: 0,
        tavoli: 0,
        poteri: 1,
        isManager: true,
        x: canvas.width / 2,
        y: 100,
        vx: 0,
        vy: 0,
        fx: null,
        fy: null,
        radius: 45
      });
      
      // Usa i dati reali del sotto-staff
      const staffData = window.sottoStaffData || [];
      
      // Aggiungi i nodi del sotto-staff
      staffData.forEach(member => {
        const performance = (member.personePortate || 0) + (member.tavoli || 0) * 2;
        let nodeType = 'pr-new';
        if (performance > 20) nodeType = 'pr-high';
        else if (performance > 5) nodeType = 'pr-normal';
        
        nodes.push({
          id: member.id,
          name: member.nickname,
          role: 'PR',
          level: member.livello || 1,
          personePortate: member.personePortate || 0,
          tavoli: member.tavoli || 0,
          poteri: member.poteri || 0,
          nodeType: nodeType,
          performance: performance,
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: 0,
          vy: 0,
          fx: null,
          fy: null,
          radius: Math.max(25, Math.min(40, 25 + performance * 0.5))
        });
        
        // Crea link - se non ha padre, collegalo al manager
        let parentId = member.fk_padre;
        
        // Se non ha padre, collegalo al manager
        if (!parentId) {
          parentId = managerId;
        }
        
        // Verifica che il parent esista nei nodi
        const parentExists = nodes.find(n => n.id == parentId);
        if (parentExists) {
          links.push({
            source: parentId,
            target: member.id,
            strength: 0.8
          });
        } else {
          // Se il parent non esiste, collega al manager
          links.push({
            source: managerId,
            target: member.id,
            strength: 0.8
          });
        }
      });
      
      // Se non ci sono dati del sotto-staff, crea un nodo placeholder
      if (staffData.length === 0) {
        nodes.push({
          id: 'placeholder',
          name: 'Nessun sotto-staff',
          role: 'INFO',
          level: 1,
          personePortate: 0,
          tavoli: 0,
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: 0,
          vy: 0,
          fx: canvas.width / 2,
          fy: canvas.height / 2,
          radius: 30
        });
        
        links.push({
          source: managerId,
          target: 'placeholder',
          strength: 0.5
        });
      }
      
      console.log('Manager ID:', managerId);
      console.log('Nodes:', nodes.map(n => ({ id: n.id, name: n.name, isManager: n.isManager })));
      console.log('Links:', links);
      
      updateLayout();
      updateStructureInfo();
    }

    function updateLayout() {
      console.log(`Aggiornamento layout con modalit√†: ${currentMode}`);
      if (currentMode === 'tree') {
        console.log('Applicazione layout albero');
        layoutTree();
      } else if (currentMode === 'hierarchy') {
        console.log('Applicazione layout gerarchico');
        layoutHierarchy();
      } else if (currentMode === 'circular') {
        console.log('Applicazione layout circolare');
        layoutCircular();
      } else {
        console.log('Applicazione layout rete');
        layoutNetwork();
      }
      console.log('Layout aggiornato');
    }

    function layoutTree() {
      // Layout ad albero migliorato
      const levels = {};
      nodes.forEach(node => {
        if (!levels[node.level]) levels[node.level] = [];
        levels[node.level].push(node);
      });
      
      const levelHeight = canvas.height / (Object.keys(levels).length + 1);
      
      Object.keys(levels).forEach((level, levelIndex) => {
        const nodesInLevel = levels[level];
        const nodeWidth = canvas.width / (nodesInLevel.length + 1);
        
        nodesInLevel.forEach((node, nodeIndex) => {
          node.fx = nodeWidth * (nodeIndex + 1);
          node.fy = levelHeight * (levelIndex + 1);
          node.x = node.fx;
          node.y = node.fy;
        });
      });
    }

    function layoutHierarchy() {
      const levels = {};
      nodes.forEach(node => {
        if (!levels[node.level]) levels[node.level] = [];
        levels[node.level].push(node);
      });
      
      const levelHeight = canvas.height / (Object.keys(levels).length + 1);
      
      Object.keys(levels).forEach((level, levelIndex) => {
        const nodesInLevel = levels[level];
        const nodeWidth = canvas.width / (nodesInLevel.length + 1);
        
        nodesInLevel.forEach((node, nodeIndex) => {
          node.fx = nodeWidth * (nodeIndex + 1);
          node.fy = levelHeight * (levelIndex + 1);
          node.x = node.fx;
          node.y = node.fy;
        });
      });
    }

    function layoutCircular() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(canvas.width, canvas.height) / 3;
      
      // Manager al centro
      const manager = nodes.find(n => n.isManager);
      if (manager) {
        manager.fx = centerX;
        manager.fy = centerY;
        manager.x = centerX;
        manager.y = centerY;
      }
      
      // Altri nodi in cerchio
      const otherNodes = nodes.filter(n => !n.isManager);
      otherNodes.forEach((node, index) => {
        const angle = (2 * Math.PI * index) / otherNodes.length;
        node.fx = centerX + radius * Math.cos(angle);
        node.fy = centerY + radius * Math.sin(angle);
        node.x = node.fx;
        node.y = node.fy;
      });
    }

    function layoutNetwork() {
      nodes.forEach(node => {
        node.fx = null;
        node.fy = null;
      });
    }

    function centerView() {
      transform.x = 0;
      transform.y = 0;
      transform.scale = 1;
    }

    function toggleFullscreen() {
      const container = document.querySelector('.organigramma-container');
      if (!document.fullscreenElement) {
        container.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function updateStructureInfo() {
      // Aggiorna le informazioni sulla struttura
      const levels = [...new Set(nodes.map(n => n.level))].length;
      const connections = links.length;
      
      document.getElementById('hierarchyLevels').textContent = levels;
      document.getElementById('connectionCount').textContent = connections;
    }

    function setupControls() {
      console.log('Configurazione controlli organigramma...');
      
      // Usa delegazione eventi per maggiore affidabilit√†
      document.addEventListener('click', function(e) {
        const target = e.target.closest('.control-btn[data-mode]');
        if (target) {
          const mode = target.dataset.mode;
          console.log(`Clic su modalit√†: ${mode}`);
          setMode(mode);
          return;
        }
        
        // Gestisci altri pulsanti
        if (e.target.closest('#resetView')) {
          console.log('Clic su Reset Vista');
          resetView();
        } else if (e.target.closest('#centerView')) {
          console.log('Clic su Centra Vista');
          fitToScreen();
        } else if (e.target.closest('#zoomIn')) {
          console.log('Clic su Zoom In');
          zoom(1.2);
        } else if (e.target.closest('#zoomOut')) {
          console.log('Clic su Zoom Out');
          zoom(0.8);
        }
      });
      
      console.log('Event listeners configurati con delegazione');
      
      // Verifica che i pulsanti esistano
      const modes = ['tree', 'hierarchy', 'network', 'circular'];
      modes.forEach(mode => {
        const btn = document.getElementById(`view${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        if (btn) {
          console.log(`Pulsante ${mode} trovato:`, btn);
        } else {
          console.error(`Pulsante ${mode} NON trovato!`);
        }
      });
      
      // Reset Vista
      document.getElementById('resetView')?.addEventListener('click', () => {
        resetView();
      });
      
      // Centra Vista
      document.getElementById('centerView')?.addEventListener('click', () => {
        centerView();
      });
      
      // Schermo Intero
      document.getElementById('fullscreen')?.addEventListener('click', () => {
        toggleFullscreen();
      });
      
      // Controlli Zoom
      document.getElementById('zoom-in')?.addEventListener('click', () => {
        zoom(1.2);
      });
      
      // Altri controlli specifici non gestiti dalla delegazione
      // Schermo Intero
      document.getElementById('fullscreen')?.addEventListener('click', () => {
        toggleFullscreen();
      });
    }

    function setMode(mode) {
      console.log(`Cambio modalit√† visualizzazione: ${currentMode} -> ${mode}`);
      currentMode = mode;
      
      // Aggiorna bottoni
      document.querySelectorAll('.control-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeBtn = document.querySelector(`[data-mode="${mode}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        console.log(`Pulsante ${mode} attivato`);
      } else {
        console.error(`Pulsante per modalit√† ${mode} non trovato!`);
      }
      
      console.log('Aggiornamento layout...');
      updateLayout();
    }

    function resetView() {
      transform = { x: 0, y: 0, scale: 1 };
    }

    function zoom(factor) {
      transform.scale *= factor;
      transform.scale = Math.max(0.1, Math.min(3, transform.scale));
    }

    function fitToScreen() {
      if (nodes.length === 0) return;
      
      let minX = Infinity, maxX = -Infinity;
      let minY = Infinity, maxY = -Infinity;
      
      nodes.forEach(node => {
        minX = Math.min(minX, node.x - node.radius);
        maxX = Math.max(maxX, node.x + node.radius);
        minY = Math.min(minY, node.y - node.radius);
        maxY = Math.max(maxY, node.y + node.radius);
      });
      
      const width = maxX - minX;
      const height = maxY - minY;
      const scale = Math.min(canvas.width / width, canvas.height / height) * 0.8;
      
      transform.scale = scale;
      transform.x = (canvas.width - (minX + maxX) * scale) / 2;
      transform.y = (canvas.height - (minY + maxY) * scale) / 2;
    }

    function setupCanvasEvents() {
      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      canvas.addEventListener('wheel', onWheel);
      canvas.addEventListener('mouseleave', hideTooltip);
    }

    function onMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const node = getNodeAt(x, y);
      if (node) {
        selectedNode = node;
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      } else {
        isDragging = true;
        dragStart = { x: x - transform.x, y: y - transform.y };
      }
    }

    function onMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      if (isDragging) {
        if (selectedNode) {
          const worldX = (x - transform.x) / transform.scale;
          const worldY = (y - transform.y) / transform.scale;
          selectedNode.fx = worldX;
          selectedNode.fy = worldY;
          selectedNode.x = worldX;
          selectedNode.y = worldY;
        } else {
          transform.x = x - dragStart.x;
          transform.y = y - dragStart.y;
        }
      } else {
        const node = getNodeAt(x, y);
        if (node) {
          showTooltip(node, x, y);
          canvas.style.cursor = 'pointer';
        } else {
          hideTooltip();
          canvas.style.cursor = 'grab';
        }
      }
    }

    function onMouseUp() {
      isDragging = false;
      selectedNode = null;
    }

    function onWheel(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = transform.scale * factor;
      
      if (newScale >= 0.1 && newScale <= 3) {
        transform.x = x - (x - transform.x) * factor;
        transform.y = y - (y - transform.y) * factor;
        transform.scale = newScale;
      }
    }

    function getNodeAt(x, y) {
      const worldX = (x - transform.x) / transform.scale;
      const worldY = (y - transform.y) / transform.scale;
      
      return nodes.find(node => {
        const dx = worldX - node.x;
        const dy = worldY - node.y;
        return Math.sqrt(dx * dx + dy * dy) <= node.radius;
      });
    }

    function showTooltip(node, x, y) {
      const tooltip = document.getElementById('node-tooltip');
      if (!tooltip) return;
      
      // Aggiorna avatar
      const avatar = tooltip.querySelector('.tooltip-avatar');
      if (avatar) {
        avatar.textContent = node.name.charAt(0).toUpperCase();
      }
      
      // Aggiorna titolo e ruolo
      tooltip.querySelector('.tooltip-title').textContent = node.name;
      tooltip.querySelector('.tooltip-role').textContent = node.role;
      
      // Aggiorna statistiche
      document.getElementById('tooltip-persone').textContent = node.personePortate;
      document.getElementById('tooltip-tavoli').textContent = node.tavoli;
      document.getElementById('tooltip-livello').textContent = node.level;
      document.getElementById('tooltip-poteri').textContent = node.poteri ? 'S√¨' : 'No';
      
      // Aggiorna barra performance
      const performance = node.performance || 0;
      const maxPerformance = Math.max(50, performance * 1.5); // Scala dinamica
      const percentage = Math.min(100, (performance / maxPerformance) * 100);
      
      const performanceBar = document.getElementById('tooltip-performance-bar');
      const performanceText = document.getElementById('tooltip-performance-text');
      
      if (performanceBar) {
        performanceBar.style.width = percentage + '%';
      }
      if (performanceText) {
        performanceText.textContent = `Performance: ${performance.toFixed(1)}`;
      }
      
      // Posiziona tooltip
      tooltip.style.left = x + 15 + 'px';
      tooltip.style.top = y - 15 + 'px';
      tooltip.style.opacity = '1';
    }

    function hideTooltip() {
      const tooltip = document.getElementById('node-tooltip');
      if (tooltip) {
        tooltip.style.opacity = '0';
      }
    }

    function animate() {
      draw();
      requestAnimationFrame(animate);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.save();
      ctx.translate(transform.x, transform.y);
      ctx.scale(transform.scale, transform.scale);
      
      // Disegna link con pi√π evidenza
      ctx.strokeStyle = '#6c757d';
      ctx.lineWidth = 4;
      links.forEach(link => {
        const source = nodes.find(n => n.id == link.source); // Usa == per confronto numerico
        const target = nodes.find(n => n.id == link.target);
        if (source && target) {
          // Disegna freccia
          ctx.beginPath();
          ctx.moveTo(source.x, source.y);
          ctx.lineTo(target.x, target.y);
          ctx.stroke();
          
          // Disegna freccia all'estremit√†
          const angle = Math.atan2(target.y - source.y, target.x - source.x);
          const arrowSize = 10;
          
          ctx.save();
          ctx.translate(target.x, target.y);
          ctx.rotate(angle);
          ctx.beginPath();
          ctx.moveTo(-arrowSize, -arrowSize/2);
          ctx.lineTo(0, 0);
          ctx.lineTo(-arrowSize, arrowSize/2);
          ctx.fillStyle = '#6c757d';
          ctx.fill();
          ctx.restore();
        } else {
          console.log('Link non trovato:', link, 'Source:', source, 'Target:', target);
        }
      });
      
      // Disegna nodi
      nodes.forEach(node => {
        // Determina colore basato sul tipo
        let gradient;
        if (node.isManager) {
          gradient = ctx.createLinearGradient(
            node.x - node.radius, node.y - node.radius,
            node.x + node.radius, node.y + node.radius
          );
          gradient.addColorStop(0, '#667eea');
          gradient.addColorStop(1, '#764ba2');
        } else if (node.nodeType === 'pr-high') {
          gradient = ctx.createLinearGradient(
            node.x - node.radius, node.y - node.radius,
            node.x + node.radius, node.y + node.radius
          );
          gradient.addColorStop(0, '#00b894');
          gradient.addColorStop(1, '#00cec9');
        } else if (node.nodeType === 'pr-normal') {
          gradient = ctx.createLinearGradient(
            node.x - node.radius, node.y - node.radius,
            node.x + node.radius, node.y + node.radius
          );
          gradient.addColorStop(0, '#74b9ff');
          gradient.addColorStop(1, '#0984e3');
        } else if (node.nodeType === 'pr-new') {
          gradient = ctx.createLinearGradient(
            node.x - node.radius, node.y - node.radius,
            node.x + node.radius, node.y + node.radius
          );
          gradient.addColorStop(0, '#fd79a8');
          gradient.addColorStop(1, '#e84393');
        } else {
          gradient = '#bbb'; // Placeholder
        }
        
        // Disegna cerchio principale
        ctx.beginPath();
        ctx.arc(node.x, node.y, node.radius, 0, 2 * Math.PI);
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // Bordo con evidenza per il manager
        ctx.strokeStyle = node.isManager ? '#ffd700' : '#fff';
        ctx.lineWidth = node.isManager ? 5 : 3;
        ctx.stroke();
        
        // Indicatore poteri
        if (node.poteri && !node.isManager) {
          ctx.beginPath();
          ctx.arc(node.x + node.radius * 0.6, node.y - node.radius * 0.6, 8, 0, 2 * Math.PI);
          ctx.fillStyle = '#ffd700';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // Simbolo fulmine
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 10px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('‚ö°', node.x + node.radius * 0.6, node.y - node.radius * 0.6);
        }
        
        // Corona per il manager
        if (node.isManager) {
          ctx.fillStyle = '#ffd700';
          ctx.font = 'bold 16px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('üëë', node.x, node.y - node.radius - 15);
        }
        
        // Testo nome
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${Math.max(10, node.radius * 0.25)}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const text = node.name.length > 8 ? node.name.substring(0, 8) + '...' : node.name;
        ctx.fillText(text, node.x, node.y);
      });
      
      ctx.restore();
      
      // Aggiorna zoom percentage
      const zoomEl = document.getElementById('zoom-percentage');
      if (zoomEl) {
        zoomEl.textContent = Math.round(transform.scale * 100) + '%';
      }
    }
  </script>

</body>
</html>