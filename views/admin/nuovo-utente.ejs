
    <h1>Aggiungi Nuovo Utente</h1>
    
    <!-- Messaggi di errore e successo -->
    <% if (errorMessage) { %>
      <div class="error-message">
        âŒ <%= errorMessage %>
      </div>
    <% } %>
    
    <% if (successMessage) { %>
      <div class="success-message">
        âœ… <%= successMessage %>
      </div>
    <% } %>
    
    <div class="page-header">
      <h1><i class="fas fa-user-plus"></i> Aggiungi Nuovo Utente</h1>
      <p>Crea un nuovo utente per il sistema Aura</p>
      <div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 10px; border-radius: 5px; margin-top: 10px;">
        <i class="fas fa-info-circle" style="color: #2196f3;"></i>
        <strong>Nota:</strong> Puoi creare Admin, Pre-Admin e PR. Gli Admin possono modificare solo i propri dati, non quelli di altri Admin.
      </div>
    </div>

    <div class="form-container mobile-form-container">
      <form method="POST" action="/admin/nuovo-utente" class="user-form mobile-form">
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ‘¤ Ruolo:</label>
          <select name="ruolo" id="ruolo-select" class="mobile-form-select" required>
            <option value="admin" <%= (formData && formData.ruolo === 'admin') ? 'selected' : '' %>>ğŸ”´ Admin</option>
            <option value="pre_admin" <%= (!formData || !formData.ruolo || formData.ruolo === 'pre_admin') ? 'selected' : '' %>>ğŸŸ  Pre-Admin</option>
            <option value="pr" <%= (formData && formData.ruolo === 'pr') ? 'selected' : '' %>>ğŸ”µ PR</option>
          </select>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ‘¨â€ğŸ’¼ Supervisor:</label>
          <select name="padre_id" id="padre-select" class="mobile-form-select" data-utenti='<%- JSON.stringify(utenti) %>'></select>
          <!-- Hidden div per memorizzare dati form -->
          <div id="form-data-storage" style="display:none;" data-form-data='<%- formData ? JSON.stringify(formData) : "null" %>'></div>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ·ï¸ Nickname:</label>
          <input type="text" name="nickname" class="mobile-form-input" value="<%= formData && formData.nickname ? formData.nickname : '' %>" required>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ‘¤ Nome:</label>
          <input type="text" name="nome" class="mobile-form-input" value="<%= formData && formData.nome ? formData.nome : '' %>" required>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ‘¤ Cognome:</label>
          <input type="text" name="cognome" class="mobile-form-input" value="<%= formData && formData.cognome ? formData.cognome : '' %>" required>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ“± Telefono:</label>
          <input type="text" name="numero_telefono" class="mobile-form-input" value="<%= formData && formData.numero_telefono ? formData.numero_telefono : '' %>" required>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ”’ Password:</label>
          <input type="password" name="password" class="mobile-form-input" value="<%= formData && formData.password ? formData.password : '' %>" required>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">ğŸ’° Percentuale Provvigione (%):</label>
          <input type="number" name="percentuale_provvigione" class="mobile-form-input" value="<%= formData && formData.percentuale_provvigione ? formData.percentuale_provvigione : '' %>" min="0" max="100" step="0.01" required>
        </div>
        
        <div class="mobile-form-group" id="poteri-label" style="display:none;">
          <label class="mobile-form-label">âš¡ Poteri Speciali:</label>
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
            <input type="checkbox" id="poteri-checkbox" name="poteri" value="1" <%= (formData && formData.poteri) ? 'checked' : '' %> style="width: 20px; height: 20px;">
            <span class="checkbox-helper">Concedi poteri operativi speciali al PR</span>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary-mobile submit-button" style="width: 100%; margin-top: 20px; position: relative; z-index: 1000; pointer-events: auto;">
          <i class="fas fa-user-plus"></i> Crea Utente
        </button>
      </form>
    </div>
    <style>
      .error-message {
        background-color: #ffe6e6;
        border: 1px solid #ff6b6b;
        color: #c92a2a;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: 500;
      }
      
      .success-message {
        background-color: #e6ffe6;
        border: 1px solid #51cf66;
        color: #2f9e41;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: 500;
      }
      
      .checkbox-helper {
        font-size: 0.9em;
        color: #666;
        margin-left: 10px;
      }
      
      /* CSS specifico per il bottone submit */
      .submit-button {
        position: relative !important;
        z-index: 1000 !important;
        pointer-events: auto !important;
        cursor: pointer !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        touch-action: manipulation !important;
        user-select: none !important;
        -webkit-user-select: none !important;
        -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
      }
      
      .submit-button:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0,123,255,0.3) !important;
      }
      
      .submit-button:active {
        transform: translateY(0) !important;
        box-shadow: 0 2px 8px rgba(0,123,255,0.2) !important;
      }
      
      #poteri-label {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      #poteri-checkbox {
        margin: 0 5px;
        transform: scale(1.2);
      }
      
      .poteri-info {
        background: #f0f8ff;
        border: 1px solid #b0d4f1;
        border-radius: 4px;
        padding: 10px;
        margin-top: 5px;
        font-size: 0.9em;
        color: #2c5282;
      }
    </style>
    <!-- Script esterno gestisce la logica del form e popola il dropdown dai data attributes -->
    <!-- Vedi public/js/mobile-enhancements.js -->