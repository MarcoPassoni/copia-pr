      <!-- Page header -->
      <div class="page-header">
        <h1>
          <i class="fas fa-users"></i>
          Gestione Staff
        </h1>
        <p>Visualizza e gestisci tutti i membri del team ICONIC</p>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="stat-number"><%= utenti.filter(u => u.ruolo === 'admin').length %></div>
          <div class="stat-label">Amministratori</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-cog"></i>
          </div>
          <div class="stat-number"><%= utenti.filter(u => u.ruolo === 'pre_admin').length %></div>
          <div class="stat-label">Pre-Admin</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-number"><%= utenti.filter(u => u.ruolo === 'pr').length %></div>
          <div class="stat-label">PR</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-number"><%= utenti.length %></div>
          <div class="stat-label">Totale Staff</div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="search-filter-bar">
        <div class="search-filter-grid">
          <div class="search-group">
            <input type="text" id="searchInput" placeholder="üîç Cerca per nickname, nome o cognome..." onkeyup="filterTable()">
          </div>
          <select id="roleFilter" class="filter-select" onchange="filterTable()">
            <option value="">Tutti i ruoli</option>
            <option value="admin">Admin</option>
            <option value="pre_admin">Pre-Admin</option>
            <option value="pr">PR</option>
          </select>
          <a href="/admin/nuovo-utente" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Aggiungi Utente
          </a>
        </div>
      </div>

      <!-- Staff Table -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-table"></i>
            Elenco Staff
          </h2>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="staff-table" id="staffTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nickname</th>
                <th>Ruolo</th>
                <th>Nome Completo</th>
                <th>Telefono</th>
                <th>Percentuale</th>
                <th>Poteri</th>
                <th>Padre</th>
                <th>Sotto-utenti</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% utenti.forEach(u => { %>
                <tr>
                  <td><strong><%= u.id %></strong></td>
                  <td><strong><%= u.nickname %></strong></td>
                  <td>
                    <span class="role-badge role-<%= u.ruolo %>">
                      <%= u.ruolo === 'pre_admin' ? 'Pre-Admin' : u.ruolo.toUpperCase() %>
                    </span>
                  </td>
                  <td><%= u.nome %> <%= u.cognome %></td>
                  <td>
                    <a href="tel:<%= u.numero_telefono %>" style="color: #667eea; text-decoration: none;">
                      <i class="fas fa-phone"></i> <%= u.numero_telefono %>
                    </a>
                  </td>
                  <td>
                    <% if (u.percentuale_provvigione != null) { %>
                      <strong><%= u.percentuale_provvigione %>%</strong>
                    <% } else { %>
                      <span style="color: #999;">-</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (u.ruolo === 'pr') { %>
                      <span class="power-badge power-<%= u.poteri == 1 ? 'yes' : 'no' %>">
                        <%= u.poteri == 1 ? 'SI' : 'NO' %>
                      </span>
                    <% } else { %>
                      <span style="color: #999;">-</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (u.padre_nickname) { %>
                      <strong style="color: #667eea;"><%= u.padre_nickname %></strong>
                    <% } else { %>
                      <span style="color: #999;">-</span>
                    <% } %>
                  </td>
                  <td>
                    <% const subordinati = figli.filter(f => f.padre_id === u.id); %>
                    <% if (subordinati.length > 0) { %>
                      <details class="subordinates-dropdown">
                        <summary>
                          <i class="fas fa-users"></i>
                          <%= subordinati.length %> utent<%= subordinati.length === 1 ? 'e' : 'i' %>
                        </summary>
                        <div class="subordinates-list">
                          <ul>
                            <% subordinati.forEach(f => { %>
                              <li>
                                <i class="fas fa-user"></i>
                                <strong><%= f.nickname %></strong> 
                                <span class="role-badge role-<%= f.ruolo %>"><%= f.ruolo %></span>
                              </li>
                            <% }) %>
                          </ul>
                        </div>
                      </details>
                    <% } else { %>
                      <span style="color: #999;">Nessuno</span>
                    <% } %>
                  </td>
                  <td>
                    <button class="action-btn btn-edit" onclick="editUser('<%= u.id %>', '<%= u.nickname %>', '<%= u.ruolo %>')">
                      <i class="fas fa-edit"></i>
                      Modifica
                    </button>
                    <% if (u.ruolo !== 'admin' || utenti.filter(admin => admin.ruolo === 'admin').length > 1) { %>
                      <button class="action-btn btn-delete" onclick="deleteUser('<%= u.id %>', '<%= u.nickname %>', '<%= u.ruolo %>')">
                        <i class="fas fa-trash"></i>
                        Elimina
                      </button>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal modifica utente -->
  <div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Modifica Utente</h2>
      <form id="editForm" method="POST" action="/admin/staff/edit">
        <input type="hidden" id="edit-id" name="id">
        <input type="hidden" id="edit-ruolo" name="ruolo">
        
        <label>Nickname: <input type="text" id="edit-nickname" name="nickname" required></label>
        <label>Nome: <input type="text" id="edit-nome" name="nome" required></label>
        <label>Cognome: <input type="text" id="edit-cognome" name="cognome" required></label>
        <label>Telefono: <input type="text" id="edit-telefono" name="numero_telefono" required></label>
        <label>Password (lascia vuoto per non cambiare): <input type="password" id="edit-password" name="password"></label>
        
        <!-- Campo padre - solo per pre_admin e pr -->
        <div id="padre-field" style="display: none;">
          <label>Padre:
            <select id="edit-padre" name="padre_id">
              <option value="">Nessun padre</option>
              <!-- Opzioni popolate dinamicamente -->
            </select>
          </label>
        </div>
        
        <div id="pr-fields" style="display: none;">
          <label>Percentuale provvigione: <input type="number" id="edit-percentuale" name="percentuale_provvigione" min="0" max="100" step="0.01"></label>
          <input type="hidden" name="poteri" value="0">
          <label>Poteri PR: <input type="checkbox" id="edit-poteri" name="poteri" value="1"></label>
        </div>
        
        <button type="submit">Salva modifiche</button>
        <button type="button" onclick="closeModal()">Annulla</button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Mobile menu toggle
    const hamburger = document.getElementById('hamburger');
    const adminSidebar = document.getElementById('adminSidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');

    function toggleMobileMenu() {
      hamburger.classList.toggle('active');
      adminSidebar.classList.toggle('open');
      mobileOverlay.classList.toggle('show');
      document.body.style.overflow = adminSidebar.classList.contains('open') ? 'hidden' : '';
    }

    function closeMobileMenu() {
      hamburger.classList.remove('active');
      adminSidebar.classList.remove('open');
      mobileOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    hamburger.addEventListener('click', toggleMobileMenu);
    mobileOverlay.addEventListener('click', closeMobileMenu);

    // Close mobile menu when clicking on a link
    const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
    sidebarLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          closeMobileMenu();
        }
      });
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        closeMobileMenu();
      }
    });

    // Search and filter functionality
    function filterTable() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const table = document.getElementById('staffTable');
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        const nickname = rows[i].cells[1].textContent.toLowerCase();
        const role = rows[i].cells[2].textContent.toLowerCase();
        const fullName = rows[i].cells[3].textContent.toLowerCase();
        
        const matchesSearch = nickname.includes(searchInput) || fullName.includes(searchInput);
        const matchesRole = roleFilter === '' || role.includes(roleFilter);
        
        rows[i].style.display = matchesSearch && matchesRole ? '' : 'none';
      }
    }

    // Edit user function
    function editUser(id, nickname, ruolo) {
      // Redirect to edit page (you can implement a modal here)
      window.location.href = `/admin/staff/edit/${id}`;
    }

    // Delete user function
    function deleteUser(id, nickname, ruolo) {
      if (confirm(`Sei sicuro di voler eliminare l'utente "${nickname}" (${ruolo})?`)) {
        // Send delete request
        fetch(`/admin/staff/delete/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => {
          if (response.ok) {
            location.reload();
          } else {
            alert('Errore durante l\'eliminazione dell\'utente');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Errore durante l\'eliminazione dell\'utente');
        });
      }
    }

    // Modal management
    console.log('üîß Inizializzazione modal e gestori...');

    // Gestione modal
    const modal = document.getElementById('editModal');
    const closeBtn = document.querySelector('.close');
    const editButtons = document.querySelectorAll('.edit-btn');
    console.log('Modal element:', modal);
    console.log('Close button:', closeBtn);
    
    // Dati utenti per il popolamento del modal - generati dal server
    console.log('Caricamento utenti...');
    const usersData = <%- JSON.stringify(utenti) %>;
    
    console.log('Utenti caricati direttamente:', usersData);
    console.log('Numero utenti:', usersData ? usersData.length : 0);
    console.log('Primo utente (se esiste):', usersData && usersData[0] ? usersData[0] : 'nessuno');
    
    // Verifica se i dati sono stati caricati correttamente
    if (!usersData || usersData.length === 0) {
      console.error('‚ùå Errore: dati utenti non caricati!');
      alert('Errore nel caricamento dei dati utenti. Ricarica la pagina.');
    } else {
      console.log(`‚úÖ Dati utenti caricati correttamente!`);
      console.log(`Caricati ${usersData.length} utenti con successo!`);
    }
    
    // Funzione per aprire il modal di modifica
    function openEditModal(user) {
      console.log('Apertura modal per utente:', user);
      
      // Popola i campi del form
      document.getElementById('edit-id').value = user.id;
      document.getElementById('edit-ruolo').value = user.ruolo;
      document.getElementById('edit-nickname').value = user.nickname;
      document.getElementById('edit-nome').value = user.nome;
      document.getElementById('edit-cognome').value = user.cognome;
      document.getElementById('edit-telefono').value = user.numero_telefono;
      
      // Gestisci campo padre
      const padreField = document.getElementById('padre-field');
      const padreSelect = document.getElementById('edit-padre');
      
      // Svuota il select padre
      padreSelect.innerHTML = '<option value="">Nessun padre</option>';
      
      // Mostra/nascondi campo padre in base al ruolo
      if (user.ruolo === 'admin') {
        padreField.style.display = 'none';
      } else {
        padreField.style.display = 'block';
        
        // Popola le opzioni padre in base al ruolo dell'utente
        let possibiliPadri = [];
        if (user.ruolo === 'pre_admin') {
          // Pre_admin pu√≤ avere solo admin come padre
          possibiliPadri = usersData.filter(u => u.ruolo === 'admin');
        } else if (user.ruolo === 'pr') {
          // PR pu√≤ avere admin, pre_admin o altri PR come padre (ma non se stesso)
          possibiliPadri = usersData.filter(u => (u.ruolo === 'admin' || u.ruolo === 'pre_admin' || u.ruolo === 'pr') && u.id !== user.id);
        }
        
        // Aggiungi le opzioni
        possibiliPadri.forEach(padre => {
          const option = document.createElement('option');
          option.value = padre.id;
          option.textContent = `${padre.nickname} (${padre.ruolo})`;
          padreSelect.appendChild(option);
        });
        
        // Imposta il padre attuale
        if (user.padre_id) {
          padreSelect.value = user.padre_id;
          console.log('Padre selezionato con ID diretto:', user.padre_id);
        } else if (user.padre_nickname && user.padre_nickname !== 'Nessuno') {
          // Fallback: cerca per nickname se padre_id non √® disponibile
          const padreAttuale = usersData.find(u => u.nickname === user.padre_nickname);
          console.log('Padre trovato tramite nickname:', padreAttuale);
          if (padreAttuale) {
            padreSelect.value = padreAttuale.id;
          }
        }
      }
      
      // Mostra/nascondi campi PR
      const prFields = document.getElementById('pr-fields');
      if (user.ruolo === 'pr') {
        prFields.style.display = 'block';
        document.getElementById('edit-percentuale').value = user.percentuale_provvigione;
        document.getElementById('edit-poteri').checked = user.poteri == 1;
      } else {
        prFields.style.display = 'none';
      }
      
      // Mostra il modal
      modal.style.display = 'block';
    }
    
    // Gestione click sui pulsanti modifica
    console.log('Impostazione event listeners...');
    editButtons.forEach((btn, index) => {
      btn.addEventListener('click', function(e) {
        e.preventDefault(); // Previeni comportamento default
        console.log('Click su modifica rilevato per utente ID:', this.getAttribute('data-id'));
        
        const userId = parseInt(this.getAttribute('data-id'));
        const user = usersData.find(u => u.id === userId);
        
        if (user) {
          openEditModal(user);
        } else {
          console.error('Utente non trovato!');
          alert('Errore: utente non trovato!');
        }
      });
    });
    
    // Chiudi modal
    function closeModal() {
      modal.style.display = 'none';
    }
    
    // Chiudi modal cliccando sulla X
    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }
    
    // Chiudi modal cliccando fuori
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });

    console.log('üöÄ ICONIC Staff Management caricato!');
  </script>

