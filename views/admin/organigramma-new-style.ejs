<!-- Page header -->
<div class="page-header">
  <h1>
    <i class="fas fa-sitemap"></i>
    Organigramma Aziendale
  </h1>
  <p>Visualizza la struttura gerarchica del team ICONIC</p>
</div>

<!-- Stats organigramma -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon admin">
      <i class="fas fa-user-shield"></i>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= statistiche.admin %></div>
      <div class="stat-label">Amministratori</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon pre-admin">
      <i class="fas fa-user-cog"></i>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= statistiche.pre_admin %></div>
      <div class="stat-label">Pre-Admin</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon pr">
      <i class="fas fa-user-tie"></i>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= statistiche.pr %></div>
      <div class="stat-label">PR</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon total">
      <i class="fas fa-users"></i>
    </div>
    <div class="stat-content">
      <div class="stat-number"><%= statistiche.totale %></div>
      <div class="stat-label">Totale Staff</div>
    </div>
  </div>
</div>

<!-- Controlli organigramma -->
<div class="data-section">
  <div class="section-header">
    <h2><i class="fas fa-cogs"></i> Controlli Visualizzazione</h2>
  </div>
  <div class="section-content">
    <div class="organigramma-controls">
      <button id="reset-view" class="control-btn">
        <i class="fas fa-home"></i>
        <span>Vista Completa</span>
      </button>
      <button id="zoom-in" class="control-btn">
        <i class="fas fa-search-plus"></i>
        <span>Zoom +</span>
      </button>
      <button id="zoom-out" class="control-btn">
        <i class="fas fa-search-minus"></i>
        <span>Zoom -</span>
      </button>
      <button id="toggle-names" class="control-btn active">
        <i class="fas fa-eye"></i>
        <span>Nomi</span>
      </button>
      <button id="toggle-roles" class="control-btn active">
        <i class="fas fa-tags"></i>
        <span>Ruoli</span>
      </button>
    </div>
  </div>
</div>

<!-- Canvas organigramma -->
<div class="data-section">
  <div class="section-header">
    <h2><i class="fas fa-sitemap"></i> Struttura Organizzativa</h2>
  </div>
  <div class="section-content">
    <div class="organigramma-container">
      <canvas id="organigramma-canvas"></canvas>
    </div>
  </div>
</div>

<!-- CSS per l'organigramma -->
<style>
.organigramma-controls {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.control-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border: 2px solid #e3eaf7;
  border-radius: 8px;
  background: #fff;
  color: #234e7d;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  min-width: 120px;
  justify-content: center;
}

.control-btn:hover {
  border-color: #2b6cb0;
  background: #f7fafd;
  transform: translateY(-1px);
}

.control-btn.active {
  background: linear-gradient(90deg, #2b6cb0 80%, #234e7d 100%);
  color: white;
  border-color: #2b6cb0;
}

.organigramma-container {
  width: 100%;
  height: 600px;
  border: 2px solid #e3eaf7;
  border-radius: 12px;
  overflow: auto;
  position: relative;
  background: #f7fafd;
}

#organigramma-canvas {
  display: block;
  cursor: grab;
}

#organigramma-canvas:active {
  cursor: grabbing;
}

.stat-icon.total {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
}

/* Responsive controls */
@media (max-width: 768px) {
  .organigramma-controls {
    justify-content: center;
  }
  
  .control-btn {
    min-width: 100px;
    font-size: 0.9rem;
  }
  
  .organigramma-container {
    height: 400px;
  }
}
</style>

<!-- JavaScript per l'organigramma -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸŽ¯ Caricamento organigramma admin...');
  
  const canvas = document.getElementById('organigramma-canvas');
  const ctx = canvas.getContext('2d');
  const container = document.querySelector('.organigramma-container');
  
  // Dati dall'EJS
  const organigrammaData = <%- JSON.stringify(organigrammaData) %>;
  console.log('ðŸ“Š Dati organigramma ricevuti:', organigrammaData);
  
  // Stato dell'organigramma
  let scale = 1;
  let offsetX = 0;
  let offsetY = 0;
  let isDragging = false;
  let showNames = true;
  let showRoles = true;
  
  // Configurazione nodi
  const nodeConfig = {
    width: 180,
    height: 80,
    padding: 20,
    fontSize: 12,
    titleFontSize: 14
  };
  
  // Colori ruoli (coerenti con la dashboard)
  const roleColors = {
    admin: {
      bg: '#2b6cb0',
      border: '#234e7d',
      text: '#ffffff'
    },
    pre_admin: {
      bg: '#ffd700',
      border: '#e6c200',
      text: '#2b6cb0'
    },
    pr: {
      bg: '#38b000',
      border: '#267a00',
      text: '#ffffff'
    }
  };
  
  // Imposta dimensioni canvas
  function resizeCanvas() {
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width * 2; // Per alta risoluzione
    canvas.height = rect.height * 2;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(2, 2); // Per alta risoluzione
    drawOrganigramma();
  }
  
  // Costruisce l'albero gerarchico
  function buildTree(data) {
    const nodes = new Map();
    const tree = [];
    
    // Crea nodi
    data.forEach(person => {
      nodes.set(person.id, {
        ...person,
        children: []
      });
    });
    
    // Costruisce relazioni padre-figlio
    data.forEach(person => {
      const node = nodes.get(person.id);
      if (person.padre_id && nodes.has(person.padre_id)) {
        nodes.get(person.padre_id).children.push(node);
      } else {
        tree.push(node); // Nodo root (admin)
      }
    });
    
    return tree;
  }
  
  // Calcola layout posizioni
  function calculateLayout(tree) {
    const positions = new Map();
    let maxDepth = 0;
    
    function traverse(node, depth, x, siblingIndex) {
      maxDepth = Math.max(maxDepth, depth);
      
      const y = depth * (nodeConfig.height + 60);
      positions.set(node.id, { x, y, depth });
      
      if (node.children.length > 0) {
        const childSpacing = Math.max(nodeConfig.width + 40, 
          (node.children.length - 1) * (nodeConfig.width + 20) / node.children.length);
        
        const startX = x - (node.children.length - 1) * childSpacing / 2;
        
        node.children.forEach((child, index) => {
          traverse(child, depth + 1, startX + index * childSpacing, index);
        });
      }
    }
    
    // Avvia dal centro per i nodi root
    const rootSpacing = nodeConfig.width + 100;
    const startX = (tree.length - 1) * rootSpacing / 2;
    
    tree.forEach((root, index) => {
      traverse(root, 0, -startX + index * rootSpacing, index);
    });
    
    return { positions, maxDepth };
  }
  
  // Disegna un nodo
  function drawNode(person, x, y) {
    const colors = roleColors[person.ruolo] || roleColors.pr;
    
    // Shadow
    ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetX = 2;
    ctx.shadowOffsetY = 2;
    
    // Background con border radius simulato
    ctx.fillStyle = colors.bg;
    roundRect(ctx, x, y, nodeConfig.width, nodeConfig.height, 8);
    ctx.fill();
    
    // Border
    ctx.shadowColor = 'transparent';
    ctx.strokeStyle = colors.border;
    ctx.lineWidth = 2;
    roundRect(ctx, x, y, nodeConfig.width, nodeConfig.height, 8);
    ctx.stroke();
    
    // Testo
    ctx.fillStyle = colors.text;
    ctx.textAlign = 'center';
    
    let textY = y + 25;
    
    if (showNames) {
      ctx.font = `bold ${nodeConfig.titleFontSize}px Arial`;
      ctx.fillText(person.nickname, x + nodeConfig.width / 2, textY);
      textY += 18;
      
      if (person.nome && person.cognome) {
        ctx.font = `${nodeConfig.fontSize}px Arial`;
        ctx.fillText(`${person.nome} ${person.cognome}`, x + nodeConfig.width / 2, textY);
        textY += 15;
      }
    }
    
    if (showRoles) {
      ctx.font = `bold ${nodeConfig.fontSize}px Arial`;
      const roleText = person.ruolo === 'pre_admin' ? 'PRE-ADMIN' : person.ruolo.toUpperCase();
      ctx.fillText(roleText, x + nodeConfig.width / 2, textY);
    }
  }
  
  // Funzione per disegnare rettangoli con angoli arrotondati
  function roundRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
  }
  
  // Disegna connessioni
  function drawConnections(tree, positions) {
    ctx.strokeStyle = '#234e7d';
    ctx.lineWidth = 2;
    
    function drawNodeConnections(node) {
      const nodePos = positions.get(node.id);
      if (!nodePos) return;
      
      node.children.forEach(child => {
        const childPos = positions.get(child.id);
        if (!childPos) return;
        
        const fromX = nodePos.x + nodeConfig.width / 2;
        const fromY = nodePos.y + nodeConfig.height;
        const toX = childPos.x + nodeConfig.width / 2;
        const toY = childPos.y;
        
        // Linea curva elegante
        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        const midY = fromY + (toY - fromY) / 2;
        ctx.quadraticCurveTo(fromX, midY, toX, toY);
        ctx.stroke();
        
        drawNodeConnections(child);
      });
    }
    
    tree.forEach(root => drawNodeConnections(root));
  }
  
  // Disegna l'organigramma completo
  function drawOrganigramma() {
    // Pulisci canvas
    ctx.clearRect(0, 0, canvas.width / 2, canvas.height / 2);
    
    // Applica trasformazioni
    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(scale, scale);
    
    // Centra l'organigramma
    const centerX = (canvas.width / 2) / 2 / scale;
    const centerY = 50;
    ctx.translate(centerX, centerY);
    
    const tree = buildTree(organigrammaData);
    const { positions } = calculateLayout(tree);
    
    // Disegna connessioni prima dei nodi
    drawConnections(tree, positions);
    
    // Disegna nodi
    organigrammaData.forEach(person => {
      const pos = positions.get(person.id);
      if (pos) {
        drawNode(person, pos.x - nodeConfig.width / 2, pos.y);
      }
    });
    
    ctx.restore();
  }
  
  // Event listeners per controlli
  document.getElementById('reset-view').addEventListener('click', () => {
    scale = 1;
    offsetX = 0;
    offsetY = 0;
    drawOrganigramma();
  });
  
  document.getElementById('zoom-in').addEventListener('click', () => {
    scale = Math.min(scale * 1.2, 3);
    drawOrganigramma();
  });
  
  document.getElementById('zoom-out').addEventListener('click', () => {
    scale = Math.max(scale / 1.2, 0.3);
    drawOrganigramma();
  });
  
  document.getElementById('toggle-names').addEventListener('click', (e) => {
    showNames = !showNames;
    e.target.classList.toggle('active');
    drawOrganigramma();
  });
  
  document.getElementById('toggle-roles').addEventListener('click', (e) => {
    showRoles = !showRoles;
    e.target.classList.toggle('active');
    drawOrganigramma();
  });
  
  // Drag per spostare la vista
  let lastMouseX, lastMouseY;
  
  canvas.addEventListener('mousedown', (e) => {
    isDragging = true;
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
  });
  
  canvas.addEventListener('mousemove', (e) => {
    if (isDragging) {
      const deltaX = e.clientX - lastMouseX;
      const deltaY = e.clientY - lastMouseY;
      offsetX += deltaX;
      offsetY += deltaY;
      lastMouseX = e.clientX;
      lastMouseY = e.clientY;
      drawOrganigramma();
    }
  });
  
  canvas.addEventListener('mouseup', () => {
    isDragging = false;
  });
  
  canvas.addEventListener('mouseleave', () => {
    isDragging = false;
  });
  
  // Zoom con rotella mouse
  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
    scale = Math.min(Math.max(scale * zoomFactor, 0.3), 3);
    drawOrganigramma();
  });
  
  // Resize handler
  window.addEventListener('resize', resizeCanvas);
  
  // Inizializza
  resizeCanvas();
  
  console.log('âœ… Organigramma admin caricato con successo!');
});
</script>
