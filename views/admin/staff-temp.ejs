          <td>
            <button class="edit-btn" data-id="<%= u.id %>" data-ruolo="<%= u.ruolo %>">Modifica</button>
            <form method="POST" action="/admin/staff/delete" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler eliminare questo utente?');">
              <input type="hidden" name="id" value="<%= u.id %>">
              <input type="hidden" name="ruolo" value="<%= u.ruolo %>">
              <button type="submit" class="delete-btn">Elimina</button>
            </form>
          </td>
        </tr>
      <% }); %>
    </table>
    
    <!-- Modal modifica utente -->
    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Modifica Utente</h2>
        <form id="editForm" method="POST" action="/admin/staff/edit">
          <input type="hidden" id="edit-id" name="id">
          <input type="hidden" id="edit-ruolo" name="ruolo">
          
          <label>Nickname: <input type="text" id="edit-nickname" name="nickname" required></label>
          <label>Nome: <input type="text" id="edit-nome" name="nome" required></label>
          <label>Cognome: <input type="text" id="edit-cognome" name="cognome" required></label>
          <label>Telefono: <input type="text" id="edit-telefono" name="numero_telefono" required></label>
          <label>Password (lascia vuoto per non cambiare): <input type="password" id="edit-password" name="password"></label>
          
          <!-- Campo padre - solo per pre_admin e pr -->
          <div id="padre-field" style="display: none;">
            <label>Padre:
              <select id="edit-padre" name="padre_id">
                <option value="">Nessun padre</option>
                <!-- Opzioni popolate dinamicamente -->
              </select>
            </label>
          </div>
          
          <div id="pr-fields" style="display: none;">
            <label>Percentuale provvigione: <input type="number" id="edit-percentuale" name="percentuale_provvigione" min="0" max="100" step="0.01"></label>
            <input type="hidden" name="poteri" value="0">
            <label>Poteri PR: <input type="checkbox" id="edit-poteri" name="poteri" value="1"></label>
          </div>
          
          <button type="submit">Salva modifiche</button>
          <button type="button" onclick="closeModal()">Annulla</button>
        </form>
      </div>
    </div>
  </div>
  
  <style>
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .modal-content h2 {
      margin-top: 0;
      color: #2b6cb0;
    }
    .modal-content label {
      display: block;
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
      color: #234e7d;
    }
    .modal-content input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #dbeafe;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .modal-content select {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #dbeafe;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
      background-color: white;
    }
    .modal-content button {
      background: #2b6cb0;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 5px;
      margin: 1rem 0.5rem 0 0;
      cursor: pointer;
      font-size: 1rem;
    }
    .modal-content button:hover {
      background: #234e7d;
    }
    .modal-content button[type="button"] {
      background: #6b7280;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
  </style>
  
  <script>
    // Debug iniziale
    console.log('Script caricato!');
    
    const modal = document.getElementById('editModal');
    const editButtons = document.querySelectorAll('.edit-btn');
    const closeBtn = document.querySelector('.close');
    
    console.log('Modal element:', modal);
    console.log('Edit buttons found:', editButtons.length);
    console.log('Close button:', closeBtn);
    
    // Dati utenti per il popolamento del modal - generati dal server
    // Versione CORRETTA senza parsing JSON
    console.log('Caricamento utenti...');
    const usersData = <%- JSON.stringify(utenti) %>;
    
    console.log('Utenti caricati direttamente:', usersData);
    console.log('Numero utenti:', usersData ? usersData.length : 0);
    console.log('Primo utente (se esiste):', usersData && usersData[0] ? usersData[0] : 'nessuno');
    
    // Verifica che utenti sia un array valido
    if (!Array.isArray(utenti)) {
      console.error('ERRORE: utenti non è un array!', typeof utenti, utenti);
      alert('ERRORE: dati utenti non validi');
      // Non usare return nel global scope - usa invece una funzione vuota
      (function() { return; })();
    }
    
    console.log(`Caricati ${usersData.length} utenti con successo!`);
    
    // Funzione per aprire il modal
    function openEditModal(user) {
      console.log('Aprendo modal per utente:', user);
      
      // Popola il form
      document.getElementById('edit-id').value = user.id;
      document.getElementById('edit-ruolo').value = user.ruolo;
      document.getElementById('edit-nickname').value = user.nickname;
      document.getElementById('edit-nome').value = user.nome;
      document.getElementById('edit-cognome').value = user.cognome;
      document.getElementById('edit-telefono').value = user.numero_telefono;
      document.getElementById('edit-password').value = '';
      
      // Gestione campo padre
      const padreField = document.getElementById('padre-field');
      const padreSelect = document.getElementById('edit-padre');
      
      if (user.ruolo === 'admin') {
        // Admin non ha padre
        padreField.style.display = 'none';
      } else {
        // Pre_admin e PR hanno padre
        padreField.style.display = 'block';
        
        // Popola la dropdown dei possibili padri
        padreSelect.innerHTML = '<option value="">Nessun padre</option>';
        
        // Filtra i possibili padri in base al ruolo
        let possibiliPadri = [];
        if (user.ruolo === 'pre_admin') {
          // Pre_admin può avere solo admin come padre
          possibiliPadri = usersData.filter(u => u.ruolo === 'admin');
        } else if (user.ruolo === 'pr') {
          // PR può avere admin, pre_admin o altri PR come padre (ma non se stesso)
          possibiliPadri = usersData.filter(u => (u.ruolo === 'admin' || u.ruolo === 'pre_admin' || u.ruolo === 'pr') && u.id !== user.id);
        }
        
        // Aggiungi le opzioni
        possibiliPadri.forEach(padre => {
          const option = document.createElement('option');
          option.value = padre.id;
          option.textContent = `${padre.nickname} (${padre.ruolo})`;
          padreSelect.appendChild(option);
        });
        
        // Seleziona il padre attuale (se esiste)
        console.log('Cercando padre per utente:', user.nickname, 'padre_id:', user.padre_id, 'padre_nickname:', user.padre_nickname);
        if (user.padre_id) {
          // Usa l'ID diretto del padre se disponibile
          padreSelect.value = user.padre_id;
          console.log('Padre selezionato con ID diretto:', user.padre_id);
        } else if (user.padre_nickname && user.padre_nickname !== 'Nessuno') {
          // Fallback: cerca per nickname se padre_id non è disponibile
          const padreAttuale = usersData.find(u => u.nickname === user.padre_nickname);
          console.log('Padre trovato tramite nickname:', padreAttuale);
          if (padreAttuale) {
            padreSelect.value = padreAttuale.id;
            console.log('Padre selezionato con ID via nickname:', padreAttuale.id);
          } else {
            console.warn('Padre non trovato! padre_nickname era:', user.padre_nickname);
          }
        }
      }
      
      // Mostra/nascondi campi PR
      const prFields = document.getElementById('pr-fields');
      if (user.ruolo === 'pr') {
        prFields.style.display = 'block';
        document.getElementById('edit-percentuale').value = user.percentuale_provvigione;
        document.getElementById('edit-poteri').checked = user.poteri == 1;
      } else {
        prFields.style.display = 'none';
      }
      
      // Mostra il modal
      modal.style.display = 'block';
    }
    
    // Gestione click sui pulsanti modifica
    console.log('Impostazione event listeners...');
    editButtons.forEach((btn, index) => {
      btn.addEventListener('click', function(e) {
        e.preventDefault(); // Previeni comportamento default
        console.log('Click su modifica rilevato per utente ID:', this.getAttribute('data-id'));
        
        const userId = parseInt(this.getAttribute('data-id'));
        const user = usersData.find(u => u.id === userId);
        
        if (user) {
          openEditModal(user);
        } else {
          console.error('Utente non trovato!');
          alert('Errore: utente non trovato!');
        }
      });
    });
    
    // Chiudi modal
    function closeModal() {
      modal.style.display = 'none';
    }
    
    // Chiudi modal cliccando sulla X
    closeBtn.addEventListener('click', closeModal);
    
    // Chiudi modal cliccando fuori
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
</body>
</html>
